/**
 * åœ°å›¾æ¢ç´¢ç»„ä»¶ - ä½¿ç”¨åä¸º Map Kit
 */

import { map, mapCommon, site, MapComponent } from '@kit.MapKit';
import { AsyncCallback } from '@kit.BasicServicesKit';
import { Colors, FontSizes, Spacing, Radius } from '../../utils/Constants';

// çƒ­é—¨åŸå¸‚åæ ‡
interface CityLocation {
  name: string;
  emoji: string;
  latitude: number;
  longitude: number;
  count: number;
}

@Component
export struct MapExplore {
  // åœ°å›¾æ§åˆ¶å™¨
  private mapController?: map.MapComponentController;
  // åœ°å›¾å›è°ƒ
  private mapCallback?: AsyncCallback<map.MapComponentController>;
  // åœ°å›¾é€‰é¡¹
  private mapOptions?: mapCommon.MapOptions;

  @State isMapReady: boolean = false;
  @State currentZoom: number = 3;
  @State selectedCity: CityLocation | null = null;

  // çƒ­é—¨åŸå¸‚ä½ç½®
  private hotCities: CityLocation[] = [
    { name: 'å·´é»', emoji: 'ğŸ—¼', latitude: 48.8566, longitude: 2.3522, count: 12580 },
    { name: 'çº½çº¦', emoji: 'ğŸ—½', latitude: 40.7128, longitude: -74.0060, count: 10234 },
    { name: 'ä¸œäº¬', emoji: 'ğŸ¯', latitude: 35.6762, longitude: 139.6503, count: 9876 },
    { name: 'æˆéƒ½', emoji: 'ğŸ¼', latitude: 30.5728, longitude: 104.0668, count: 8654 },
    { name: 'ä¼¦æ•¦', emoji: 'ğŸ¡', latitude: 51.5074, longitude: -0.1278, count: 7832 },
    { name: 'æ‚‰å°¼', emoji: 'ğŸ¦˜', latitude: -33.8688, longitude: 151.2093, count: 6543 },
    { name: 'è¿ªæ‹œ', emoji: 'ğŸœï¸', latitude: 25.2048, longitude: 55.2708, count: 5432 },
    { name: 'æ–°åŠ å¡', emoji: 'ğŸ¦', latitude: 1.3521, longitude: 103.8198, count: 4321 },
  ];

  aboutToAppear(): void {
    // åˆå§‹åŒ–åœ°å›¾é€‰é¡¹ - ä»¥ä¸­å›½ä¸ºä¸­å¿ƒçš„ä¸–ç•Œè§†è§’
    this.mapOptions = {
      position: {
        target: {
          latitude: 30.0,
          longitude: 110.0
        },
        zoom: this.currentZoom
      },
      mapType: mapCommon.MapType.STANDARD,
      myLocationControlsEnabled: false,
      compassControlsEnabled: false,
      zoomControlsEnabled: false,
      scaleControlsEnabled: false
    };

    // åœ°å›¾å›è°ƒ
    this.mapCallback = async (err, controller) => {
      if (!err) {
        this.mapController = controller;
        this.isMapReady = true;
        // æ·»åŠ åŸå¸‚æ ‡è®°
        this.addCityMarkers();
      }
    };
  }

  // æ·»åŠ åŸå¸‚æ ‡è®°ç‚¹
  private async addCityMarkers(): Promise<void> {
    if (!this.mapController) return;

    for (const city of this.hotCities) {
      try {
        const markerOptions: mapCommon.MarkerOptions = {
          position: {
            latitude: city.latitude,
            longitude: city.longitude
          },
          title: city.name,
          snippet: `${city.emoji} ${(city.count / 1000).toFixed(1)}k äººæ‰“å¡`,
          clickable: true
        };

        const marker = await this.mapController.addMarker(markerOptions);
        if (marker) {
          marker.setClickable(true);
        }
      } catch (e) {
        console.error(`æ·»åŠ æ ‡è®°å¤±è´¥: ${city.name}`, e);
      }
    }

    // ç›‘å¬æ ‡è®°ç‚¹å‡»
    this.mapController.on('markerClick', (marker) => {
      const position = marker.getPosition();
      const city = this.hotCities.find(c => 
        Math.abs(c.latitude - position.latitude) < 0.01 && 
        Math.abs(c.longitude - position.longitude) < 0.01
      );
      if (city) {
        this.selectedCity = city;
      }
      return true;
    });

    // ç›‘å¬åœ°å›¾ç‚¹å‡»å…³é—­é€‰ä¸­
    this.mapController.on('mapClick', () => {
      this.selectedCity = null;
    });
  }

  // é£åˆ°æŒ‡å®šåŸå¸‚
  flyToCity(city: CityLocation): void {
    if (!this.mapController) return;

    const cameraUpdate = map.newCameraPosition({
      target: {
        latitude: city.latitude,
        longitude: city.longitude
      },
      zoom: 10
    });

    this.mapController.animateCamera(cameraUpdate, 1000);
    this.selectedCity = city;
  }

  // ç¼©æ”¾æ§åˆ¶
  zoomIn(): void {
    if (!this.mapController || this.currentZoom >= 20) return;
    this.currentZoom += 1;
    const cameraUpdate = map.newCameraPosition({
      target: { latitude: 30.0, longitude: 110.0 },
      zoom: this.currentZoom
    });
    this.mapController.animateCamera(cameraUpdate, 300);
  }

  zoomOut(): void {
    if (!this.mapController || this.currentZoom <= 1) return;
    this.currentZoom -= 1;
    const cameraUpdate = map.newCameraPosition({
      target: { latitude: 30.0, longitude: 110.0 },
      zoom: this.currentZoom
    });
    this.mapController.animateCamera(cameraUpdate, 300);
  }

  // é‡ç½®è§†å›¾
  resetView(): void {
    if (!this.mapController) return;
    const cameraUpdate = map.newCameraPosition({
      target: { latitude: 30.0, longitude: 110.0 },
      zoom: 3
    });
    this.mapController.animateCamera(cameraUpdate, 800);
    this.currentZoom = 3;
    this.selectedCity = null;
  }

  build() {
    Stack() {
      // åä¸ºåœ°å›¾ç»„ä»¶
      if (this.mapOptions) {
        MapComponent({
          mapOptions: this.mapOptions,
          mapCallback: this.mapCallback
        })
          .width('100%')
          .height('100%')
      }

      // åœ°å›¾åŠ è½½ä¸­æç¤º
      if (!this.isMapReady) {
        Column() {
          LoadingProgress()
            .width(60)
            .height(60)
            .color(Colors.primary)
          Text('åœ°å›¾åŠ è½½ä¸­...')
            .fontSize(FontSizes.body)
            .fontColor(Colors.textSecondary)
            .margin({ top: 12 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .backgroundColor('rgba(255,255,255,0.9)')
      }

      // ç¼©æ”¾æ§åˆ¶æŒ‰é’®
      Column() {
        this.ZoomButton('+', () => this.zoomIn())
        Divider().width(36).color('#E5E5E5')
        this.ZoomButton('-', () => this.zoomOut())
      }
      .backgroundColor(Colors.bgPrimary)
      .borderRadius(Radius.md)
      .shadow({ radius: 8, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
      .position({ x: '85%', y: '40%' })

      // é‡ç½®è§†å›¾æŒ‰é’®
      Column() {
        Text('ğŸŒ')
          .fontSize(24)
      }
      .width(44)
      .height(44)
      .backgroundColor(Colors.bgPrimary)
      .borderRadius(22)
      .justifyContent(FlexAlign.Center)
      .shadow({ radius: 8, color: 'rgba(0,0,0,0.1)', offsetY: 2 })
      .position({ x: '85%', y: '55%' })
      .onClick(() => this.resetView())

      // é€‰ä¸­åŸå¸‚å¡ç‰‡
      if (this.selectedCity) {
        this.CityInfoCard(this.selectedCity)
      }

      // åº•éƒ¨çƒ­é—¨åŸå¸‚æ»šåŠ¨
      this.HotCitiesBar()
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  ZoomButton(label: string, onClick: () => void) {
    Text(label)
      .fontSize(24)
      .fontWeight(FontWeight.Medium)
      .fontColor(Colors.textPrimary)
      .width(44)
      .height(44)
      .textAlign(TextAlign.Center)
      .onClick(onClick)
  }

  @Builder
  CityInfoCard(city: CityLocation) {
    Column() {
      Row() {
        Text(city.emoji)
          .fontSize(40)
        
        Column() {
          Text(city.name)
            .fontSize(FontSizes.h4)
            .fontWeight(FontWeight.Bold)
            .fontColor(Colors.textPrimary)
          Text(`${(city.count / 1000).toFixed(1)}k äººæ‰“å¡`)
            .fontSize(FontSizes.small)
            .fontColor(Colors.textTertiary)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
        
        Blank()
        
        Button('æ¢ç´¢')
          .fontSize(FontSizes.bodySmall)
          .fontColor(Colors.textWhite)
          .backgroundColor(Colors.primary)
          .borderRadius(Radius.full)
          .height(32)
          .onClick(() => {
            // TODO: è·³è½¬åˆ°åŸå¸‚è¯¦æƒ…
          })
      }
      .width('100%')
      .padding(16)
    }
    .width('90%')
    .backgroundColor(Colors.bgPrimary)
    .borderRadius(Radius.card)
    .shadow({ radius: 16, color: 'rgba(0,0,0,0.15)', offsetY: 4 })
    .position({ x: '5%', y: '70%' })
  }

  @Builder
  HotCitiesBar() {
    Column() {
      Row() {
        Text('ğŸ”¥')
          .fontSize(16)
          Text('çƒ­é—¨ç›®çš„åœ°')
          .fontSize(FontSizes.bodySmall)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.textPrimary)
          .margin({ left: 4 })
      }
      .width('100%')
      .padding({ left: Spacing.pagePadding, bottom: 8 })

      Scroll() {
        Row() {
          ForEach(this.hotCities, (city: CityLocation) => {
            Column() {
              Text(city.emoji)
                .fontSize(28)
              Text(city.name)
                .fontSize(FontSizes.small)
                .fontWeight(FontWeight.Medium)
                .fontColor(Colors.textPrimary)
                .margin({ top: 4 })
            }
            .width(70)
            .padding({ top: 10, bottom: 10 })
            .margin({ right: 8 })
            .backgroundColor(this.selectedCity?.name === city.name ? Colors.primaryLightest : Colors.bgPrimary)
            .borderRadius(Radius.card)
            .alignItems(HorizontalAlign.Center)
            .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetY: 2 })
            .onClick(() => this.flyToCity(city))
          })
        }
        .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .padding({ top: 12, bottom: 20 })
    .backgroundColor('rgba(255,255,255,0.95)')
    .position({ x: 0, y: '85%' })
  }
}
