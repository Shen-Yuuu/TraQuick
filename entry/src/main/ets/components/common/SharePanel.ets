/**
 * è½¬å‘åˆ†äº«å¼¹çª— - å¾®åšé£Žæ ¼
 * åº•éƒ¨å¼¹å‡ºç”¨æˆ·å¤´åƒåˆ—è¡¨ + åˆ†äº«æ­¤åˆ»æƒ³æ³•
 */

import { Colors, Radius, Spacing, FontSizes } from '../../utils/Constants';
import { User } from '../../models/User';

/**
 * åˆ†äº«é¢æ¿ç”¨çš„ç®€åŒ–ç”¨æˆ·ä¿¡æ¯
 * è°ƒç”¨æ–¹å¯ä»¥ä¼ å…¥ä»»æ„æ¥æºçš„ç”¨æˆ·åˆ—è¡¨ï¼ˆAPI / æœ¬åœ°ç¼“å­˜ / å…³æ³¨åˆ—è¡¨ç­‰ï¼‰
 */
interface ShareTarget {
  id: string;
  nickname: string;
  avatar?: string;
}

@Component
export struct SharePanel {
  @Prop isShow: boolean = false;
  @State shareText: string = '';
  @State shareAnimProgress: number = 0;
  onClose: () => void = () => {};
  onShareToUser: (userId: string, text: string) => void = () => {};

  /**
   * åˆ†äº«ç›®æ ‡ç”¨æˆ·åˆ—è¡¨ â€”â€” ç”±è°ƒç”¨æ–¹ä¼ å…¥
   * é»˜è®¤ä¸ºç©ºæ•°ç»„ï¼Œè°ƒç”¨æ–¹åº”ä»Ž API èŽ·å–å¥½å‹/å…³æ³¨åˆ—è¡¨åŽä¼ å…¥
   */
  shareTargets: ShareTarget[] = [];

  aboutToAppear(): void {
    animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
      this.shareAnimProgress = 1;
    });
  }

  build() {
    if (this.isShow) {
      Stack() {
        // é®ç½©
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0,0,0,0.4)')
          .opacity(this.shareAnimProgress)
          .onClick(() => this.onClose())

        // åº•éƒ¨é¢æ¿
        Column() {
          // æ‹–æ‹½æŒ‡ç¤ºæ¡
          Column()
            .width(40)
            .height(4)
            .borderRadius(2)
            .backgroundColor('#E2E8F0')
            .margin({ top: 12, bottom: 16 })

          // æ ‡é¢˜
          Text('åˆ†äº«åˆ°')
            .fontSize(17)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1E293B')
            .margin({ bottom: 16 })

          // ç”¨æˆ·å¤´åƒæ¨ªæ»‘åˆ—è¡¨
          Scroll() {
            Row({ space: 16 }) {
              ForEach(this.shareTargets, (target: ShareTarget) => {
                Column() {
                  // å¤´åƒ
                  if (target.avatar) {
                    Image(target.avatar)
                      .width(56)
                      .height(56)
                      .borderRadius(28)
                      .objectFit(ImageFit.Cover)
                  } else {
                    Column() {
                      Text((target.nickname || 'U').charAt(0))
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#FFFFFF')
                    }
                    .width(56)
                    .height(56)
                    .borderRadius(28)
                    .backgroundColor('#38BDF8')
                    .justifyContent(FlexAlign.Center)
                  }

                  Text(target.nickname)
                    .fontSize(11)
                    .fontColor('#64748B')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 6 })
                    .width(60)
                    .textAlign(TextAlign.Center)
                }
                .alignItems(HorizontalAlign.Center)
                .onClick(() => {
                  this.onShareToUser(target.id, this.shareText);
                  this.onClose();
                })
              })
            }
            .padding({ left: 20, right: 20 })
          }
          .scrollable(ScrollDirection.Horizontal)
          .scrollBar(BarState.Off)
          .width('100%')

          // åˆ†éš”çº¿
          Divider()
            .strokeWidth(0.5)
            .color('#F1F5F9')
            .margin({ top: 20, bottom: 16 })

          // åˆ†äº«æƒ³æ³•è¾“å…¥
          Column() {
            Text('åˆ†äº«æ­¤åˆ»çš„æƒ³æ³•')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#475569')
              .margin({ bottom: 10 })

            TextArea({ placeholder: 'è¯´ç‚¹ä»€ä¹ˆå§...', text: this.shareText })
              .width('100%')
              .height(80)
              .backgroundColor('#F8FAFC')
              .borderRadius(12)
              .padding(12)
              .fontSize(14)
              .onChange((value: string) => {
                this.shareText = value;
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20 })
          .alignItems(HorizontalAlign.Start)

          // å…¶ä»–åˆ†äº«æ–¹å¼
          Divider()
            .strokeWidth(0.5)
            .color('#F1F5F9')
            .margin({ top: 16, bottom: 16 })

          Row({ space: 28 }) {
            this.ShareMethod('ðŸ”—', 'å¤åˆ¶é“¾æŽ¥')
            this.ShareMethod('ðŸ’¬', 'å¾®ä¿¡')
            this.ShareMethod('ðŸ“±', 'æœ‹å‹åœˆ')
            this.ShareMethod('ðŸ¦', 'å¾®åš')
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)

          // å–æ¶ˆæŒ‰é’®
          Button('å–æ¶ˆ')
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#64748B')
            .backgroundColor('#F1F5F9')
            .borderRadius(24)
            .height(44)
            .width('90%')
            .margin({ top: 20, bottom: 34 })
            .onClick(() => this.onClose())
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .borderRadius({ topLeft: 20, topRight: 20 })
        .alignItems(HorizontalAlign.Center)
        .position({ x: 0, y: '100%' })
        .translate({ y: -this.shareAnimProgress * 520 })
      }
      .width('100%')
      .height('100%')
    }
  }

  @Builder
  ShareMethod(icon: string, label: string) {
    Column() {
      Column() {
        Text(icon)
          .fontSize(24)
      }
      .width(48)
      .height(48)
      .borderRadius(24)
      .backgroundColor('#F1F5F9')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      Text(label)
        .fontSize(11)
        .fontColor('#64748B')
        .margin({ top: 6 })
    }
    .alignItems(HorizontalAlign.Center)
  }
}
