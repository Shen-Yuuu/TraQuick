/**
 * æ¶ˆæ¯åˆ†ç±»åˆ—è¡¨é¡µï¼ˆç‚¹èµ/è¯„è®º/å…³æ³¨ï¼‰- ä¸¥æ ¼æ¨¡å¼
 */

import { router, promptAction } from '@kit.ArkUI';
import { ApiService, ApiMessage, MessageListData } from '../../services/ApiService';

class MessageListItem {
  id: string = '';
  type: string = '';
  title: string = '';
  subtitle: string = '';
  time: string = '';
  isRead: boolean = false;
  userId: string = '';
  userNickname: string = '';
  userAvatar: string = '';
  postId: string = '';

  constructor() {}
}

@Entry
@Component
struct MessageListPage {
  @State pageTitle: string = 'æ¶ˆæ¯';
  @State messageType: string = '';

  @State messageList: MessageListItem[] = [];
  @State isLoading: boolean = true;
  @State isRefreshing: boolean = false;
  @State isLoadingMore: boolean = false;
  @State currentPage: number = 1;
  @State totalPages: number = 1;
  @State errorMessage: string = '';

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params) {
      if (params.type) this.messageType = params.type;
      if (params.title) this.pageTitle = params.title;
    }

    this.loadMessages(true);
  }

  /**
   * åŠ è½½æ•°æ®
   */
  private async loadMessages(isRefresh: boolean = false): Promise<void> {
    if (isRefresh) {
      this.currentPage = 1;
      this.isRefreshing = true;
      this.errorMessage = '';
    } else {
      if (this.isLoadingMore || this.currentPage >= this.totalPages) {
        return;
      }
      this.isLoadingMore = true;
      this.currentPage += 1;
    }

    try {
      // æ¯é¡µ 20 æ¡
      const limit = 20;
      const result: MessageListData = await ApiService.getMessages(this.messageType, this.currentPage);

      const newItems: MessageListItem[] = [];
      for (const apiMsg of result.items) {
        newItems.push(this.formatMessageItem(apiMsg));
      }

      if (isRefresh) {
        this.messageList = newItems;
      } else {
        const combined: MessageListItem[] = [];
        for (const msg of this.messageList) {
          combined.push(msg);
        }
        for (const msg of newItems) {
          combined.push(msg);
        }
        this.messageList = combined;
      }

      // è®¡ç®—æ€»é¡µæ•°
      this.totalPages = Math.ceil(result.total / limit);
      this.errorMessage = '';

    } catch (error) {
      const err = error as Error;
      this.errorMessage = err.message || 'åŠ è½½å¤±è´¥';
      console.error('[MessageList] åŠ è½½å¤±è´¥:', err.message);
    } finally {
      this.isLoading = false;
      this.isRefreshing = false;
      this.isLoadingMore = false;
    }
  }

  /**
   * å°† API æ•°æ®æ ¼å¼åŒ–ä¸º UI éœ€è¦çš„ç»“æ„ï¼Œå¹¶æˆªæ–­æ–‡æœ¬
   */
  private formatMessageItem(apiMsg: ApiMessage): MessageListItem {
    const item = new MessageListItem();
    item.id = apiMsg.id;
    item.type = apiMsg.type;
    item.time = this.formatTime(apiMsg.createdAt);
    item.isRead = apiMsg.isRead;

    // æå–äº’åŠ¨è€…ä¿¡æ¯
    if (apiMsg.relatedUser) {
      item.userId = apiMsg.relatedUser.id;
      item.userNickname = apiMsg.relatedUser.nickname;
      item.userAvatar = apiMsg.relatedUser.avatar;
    } else {
      item.userNickname = 'æœªçŸ¥ç”¨æˆ·';
    }

    // æå–å¸–å­ä¿¡æ¯ä¸æˆªæ–­
    let postContentPreview = '';
    if (apiMsg.relatedPost && apiMsg.relatedPost.content) {
      item.postId = apiMsg.relatedPost.id;
      postContentPreview = apiMsg.relatedPost.content;
      if (postContentPreview.length > 10) {
        postContentPreview = postContentPreview.substring(0, 10) + '...';
      }
    }

    // æ ¼å¼åŒ–æ ‡é¢˜ä¸å‰¯æ ‡é¢˜
    if (this.messageType === 'like') {
      item.title = `${item.userNickname} èµäº†ä½ `;
      item.subtitle = postContentPreview ? `å†…å®¹ï¼š${postContentPreview}` : '';
    } else if (this.messageType === 'comment') {
      // è¯„è®ºå†…å®¹æœ¬èº«åœ¨ apiMsg.content é‡Œ
      let commentContent = apiMsg.content;
      if (commentContent.length > 15) {
        commentContent = commentContent.substring(0, 15) + '...';
      }
      item.title = `${item.userNickname} è¯„è®ºäº†ä½ ï¼š${commentContent}`;
      item.subtitle = postContentPreview ? `å†…å®¹ï¼š${postContentPreview}` : '';
    } else if (this.messageType === 'follow') {
      item.title = `${item.userNickname} å…³æ³¨äº†ä½ `;
      item.subtitle = '';
    } else {
      // å…œåº•
      item.title = apiMsg.title;
      item.subtitle = apiMsg.content;
    }

    return item;
  }

  /**
   * ç‚¹å‡»å•æ¡æ¶ˆæ¯
   */
  private async handleItemClick(item: MessageListItem): Promise<void> {
    // 1. æ ‡è®°å·²è¯» (ä¹è§‚æ›´æ–° UI)
    if (!item.isRead) {
      const idx = this.messageList.findIndex(m => m.id === item.id);
      if (idx !== -1) {
        const newList = [...this.messageList];
        const updated = new MessageListItem();

        updated.id = item.id;
        updated.type = item.type;
        updated.title = item.title;
        updated.subtitle = item.subtitle;
        updated.time = item.time;
        updated.userId = item.userId;
        updated.userNickname = item.userNickname;
        updated.userAvatar = item.userAvatar;
        updated.postId = item.postId;
        updated.isRead = true; // è®¾ä¸ºå·²è¯»

        newList[idx] = updated;
        this.messageList = newList;

        // è°ƒç”¨ API è®¾ä¸ºå·²è¯»
        try {
          await ApiService.markAsRead(item.id);
        } catch (e) {
          console.error('[MessageList] æ ‡è®°å·²è¯»å¤±è´¥');
        }
      }
    }

    // 2. è·³è½¬é€»è¾‘
    if (this.messageType === 'follow') {
      // å…³æ³¨ -> è·³ä¸ªäººä¸»é¡µ
      if (item.userId) {
        router.pushUrl({ url: 'pages/community/UserProfilePage', params: { userId: item.userId } }).catch(()=>{});
      }
    } else {
      // ç‚¹èµ/è¯„è®º -> è·³å¸–å­è¯¦æƒ…
      if (item.postId) {
        router.pushUrl({ url: 'pages/community/PostDetailPage', params: { postId: item.postId } }).catch(()=>{});
      } else {
        promptAction.showToast({ message: 'åŸå†…å®¹å·²ä¸å­˜åœ¨' });
      }
    }
  }

  /**
   * å·¥å…·ï¼šæ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
   */
  private formatTime(isoString: string): string {
    if (!isoString) return '';
    const date = new Date(isoString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (minutes < 1) return 'åˆšåˆš';
    if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days === 1) return 'æ˜¨å¤©';
    return `${date.getMonth() + 1}-${date.getDate()}`;
  }

  private goBack(): void {
    router.back();
  }

  build() {
    Column() {
      // ====== é¡¶éƒ¨å¯¼èˆªæ  ======
      Row() {
        Row() {
          Text('â†')
            .fontSize(28)
            .fontColor('#1E293B')
        }
        .width(44)
        .height(44)
        .justifyContent(FlexAlign.Center)
        .onClick(() => this.goBack())

        Text(this.pageTitle)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1E293B')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Column() {
          Text('å…¨éƒ¨å·²è¯»')
            .fontSize(14)
            .fontColor('#38BDF8')
        }
        .width(80)
        .height(44)
        .justifyContent(FlexAlign.Center)
        .onClick(async () => {
          try {
            await ApiService.markAllRead(this.messageType);
            promptAction.showToast({ message: 'å·²å…¨éƒ¨æ ‡ä¸ºå·²è¯»' });
            this.loadMessages(true);
          } catch (e) {
            promptAction.showToast({ message: 'æ“ä½œå¤±è´¥' });
          }
        })
      }
      .width('100%')
      .padding({ left: 8, right: 8, top: 44, bottom: 12 }) // é€‚é…çŠ¶æ€æ 
      .backgroundColor('#FFFFFF')
      .border({ width: { bottom: 0.5 }, color: '#F1F5F9' })

      // ====== åˆ—è¡¨å†…å®¹ ======
      Refresh({ refreshing: $$this.isRefreshing }) {
        List() {
          // é”™è¯¯æç¤º
          if (this.errorMessage) {
            ListItem() {
              Row() {
                Text('âš ï¸').fontSize(14)
                Text(this.errorMessage).fontSize(13).fontColor('#EF4444').margin({ left: 6 })
                Text(' ç‚¹å‡»é‡è¯•').fontSize(13).fontColor('#38BDF8')
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#FEF2F2')
              .justifyContent(FlexAlign.Center)
              .onClick(() => this.loadMessages(true))
            }
          }

          // ç©ºçŠ¶æ€
          if (this.messageList.length === 0 && !this.isLoading && !this.isRefreshing) {
            ListItem() {
              Column() {
                Text('ğŸ“­').fontSize(48)
                Text('æš‚æ— æ¶ˆæ¯').fontSize(14).fontColor('#94A3B8').margin({ top: 12 })
              }
              .width('100%')
              .padding({ top: 100 })
              .alignItems(HorizontalAlign.Center)
            }
          }

          // æ•°æ®åˆ—è¡¨
          ForEach(this.messageList, (item: MessageListItem) => {
            ListItem() {
              this.MessageCard(item)
            }
          }, (item: MessageListItem) => `${item.id}_${item.isRead}`)

          // åº•éƒ¨åŠ è½½çŠ¶æ€
          if (this.isLoadingMore) {
            ListItem() {
              Row() {
                LoadingProgress().width(24).height(24).color('#38BDF8')
                Text('åŠ è½½ä¸­...').fontSize(13).fontColor('#94A3B8').margin({ left: 8 })
              }
              .width('100%')
              .height(60)
              .justifyContent(FlexAlign.Center)
            }
          } else if (this.currentPage >= this.totalPages && this.messageList.length > 0) {
            ListItem() {
              Text('â€” æ²¡æœ‰æ›´å¤šäº† â€”')
                .fontSize(13)
                .fontColor('#CBD5E1')
                .width('100%')
                .height(60)
                .textAlign(TextAlign.Center)
            }
          }
        }
        .width('100%')
        .layoutWeight(1)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onReachEnd(() => {
          if (!this.isLoadingMore && this.currentPage < this.totalPages) {
            this.loadMessages(false);
          }
        })
      }
      .onRefreshing(() => this.loadMessages(true))
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8FAFC')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  MessageCard(item: MessageListItem) {
    Row() {
      // å¤´åƒ
      Stack() {
        if (item.userAvatar) {
          Image(item.userAvatar)
            .width(48)
            .height(48)
            .borderRadius(24)
            .objectFit(ImageFit.Cover)
        } else {
          Column() {
            Text(item.userNickname ? item.userNickname.charAt(0) : 'U')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
          }
          .width(48)
          .height(48)
          .borderRadius(24)
          .backgroundColor('#38BDF8')
          .justifyContent(FlexAlign.Center)
        }
      }
      .margin({ right: 12 })

      // å†…å®¹åŒº
      Column() {
        Row() {
          Text(item.title)
            .fontSize(15)
            .fontWeight(item.isRead ? FontWeight.Medium : FontWeight.Bold)
            .fontColor(item.isRead ? '#475569' : '#1E293B')
            .layoutWeight(1)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(item.time)
            .fontSize(12)
            .fontColor('#94A3B8')
            .margin({ left: 8 })
        }
        .width('100%')

        if (item.subtitle) {
          Text(item.subtitle)
            .fontSize(13)
            .fontColor('#64748B')
            .margin({ top: 6 })
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor('#F1F5F9')
            .borderRadius(6)
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // æœªè¯»çº¢ç‚¹
      if (!item.isRead) {
        Column()
          .width(8)
          .height(8)
          .backgroundColor('#EF4444')
          .borderRadius(4)
          .margin({ left: 12 })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .border({ width: { bottom: 0.5 }, color: '#F1F5F9' })
    .onClick(() => this.handleItemClick(item))
  }
}