/**
 * æ³¨å†Œé¡µé¢
 */

import { Colors, FontSizes, Spacing, Radius, Sizes } from '../../utils/Constants';
import { router } from '@kit.ArkUI';

@Entry
@Component
struct RegisterPage {
  @State nickname: string = '';
  @State account: string = '';
  @State password: string = '';
  @State confirmPassword: string = '';
  @State verifyCode: string = '';
  @State isPasswordVisible: boolean = false;
  @State countdown: number = 0;
  @State isLoading: boolean = false;
  @State agreeTerms: boolean = false;

  build() {
    Column() {
      // èƒŒæ™¯è£…é¥°
      Column()
        .width('100%')
        .height('25%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#E0F2FE', 0], ['#FFFFFF', 1]]
        })
        .position({ x: 0, y: 0 })

      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor(Colors.textPrimary)
          .onClick(() => {
            router.back();
          })

        Text('æ³¨å†Œ')
          .fontSize(FontSizes.h4)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.textPrimary)

        // å ä½ä¿æŒå±…ä¸­
        Text('')
          .width(24)
      }
      .width('100%')
      .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 56, bottom: 20 })

      // è¡¨å•åŒºåŸŸ
      Scroll() {
        Column() {
          // Logo
          Column() {
            Text('ðŸŒ')
              .fontSize(48)
            Text('åŠ å…¥ TraQuick')
              .fontSize(FontSizes.h4)
              .fontWeight(FontWeight.Medium)
              .fontColor(Colors.textPrimary)
              .margin({ top: 12 })
            Text('å¼€å¯ä½ çš„æŽ¢ç´¢ä¹‹æ—…')
              .fontSize(FontSizes.bodySmall)
              .fontColor(Colors.textTertiary)
              .margin({ top: 4 })
          }
          .margin({ bottom: 32 })
          .alignItems(HorizontalAlign.Center)

          // æ˜µç§°è¾“å…¥
          this.InputField('æ˜µç§°', 'ðŸ‘¤', 'è¯·è¾“å…¥æ˜µç§°', this.nickname, (value: string) => {
            this.nickname = value;
          })

          // è´¦å·è¾“å…¥
          this.InputField('æ‰‹æœº/é‚®ç®±', 'ðŸ“±', 'è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®±', this.account, (value: string) => {
            this.account = value;
          })

          // éªŒè¯ç è¾“å…¥
          Column() {
            Text('éªŒè¯ç ')
              .fontSize(FontSizes.bodySmall)
              .fontWeight(FontWeight.Medium)
              .fontColor(Colors.textSecondary)
              .margin({ bottom: 8, left: 4 })

            Row() {
              Text('âœ‰ï¸')
                .fontSize(18)
                .margin({ right: 12 })

              TextInput({ placeholder: 'è¯·è¾“å…¥éªŒè¯ç ', text: this.verifyCode })
                .layoutWeight(1)
                .backgroundColor('transparent')
                .fontSize(FontSizes.body)
                .fontColor(Colors.textPrimary)
                .placeholderColor(Colors.textQuaternary)
                .caretColor(Colors.primary)
                .onChange((value: string) => {
                  this.verifyCode = value;
                })

              Button(this.countdown > 0 ? `${this.countdown}s` : 'èŽ·å–éªŒè¯ç ')
                .fontSize(FontSizes.small)
                .fontColor(this.countdown > 0 ? Colors.textQuaternary : Colors.primary)
                .backgroundColor('transparent')
                .enabled(this.countdown === 0)
                .onClick(() => {
                  this.sendVerifyCode();
                })
            }
            .width('100%')
            .height(Sizes.inputHeight)
            .padding({ left: 16, right: 16 })
            .backgroundColor(Colors.bgSecondary)
            .borderRadius(Radius.input)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 16 })

          // å¯†ç è¾“å…¥
          Column() {
            Text('å¯†ç ')
              .fontSize(FontSizes.bodySmall)
              .fontWeight(FontWeight.Medium)
              .fontColor(Colors.textSecondary)
              .margin({ bottom: 8, left: 4 })

            Row() {
              Text('ðŸ”’')
                .fontSize(18)
                .margin({ right: 12 })

              TextInput({ placeholder: 'è¯·è®¾ç½®8-20ä½å¯†ç ', text: this.password })
                .layoutWeight(1)
                .backgroundColor('transparent')
                .fontSize(FontSizes.body)
                .fontColor(Colors.textPrimary)
                .placeholderColor(Colors.textQuaternary)
                .caretColor(Colors.primary)
                .type(this.isPasswordVisible ? InputType.Normal : InputType.Password)
                .onChange((value: string) => {
                  this.password = value;
                })

              Text(this.isPasswordVisible ? 'ðŸ‘ï¸' : 'ðŸ™ˆ')
                .fontSize(18)
                .onClick(() => {
                  this.isPasswordVisible = !this.isPasswordVisible;
                })
            }
            .width('100%')
            .height(Sizes.inputHeight)
            .padding({ left: 16, right: 16 })
            .backgroundColor(Colors.bgSecondary)
            .borderRadius(Radius.input)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 16 })

          // ç¡®è®¤å¯†ç 
          Column() {
            Text('ç¡®è®¤å¯†ç ')
              .fontSize(FontSizes.bodySmall)
              .fontWeight(FontWeight.Medium)
              .fontColor(Colors.textSecondary)
              .margin({ bottom: 8, left: 4 })

            Row() {
              Text('ðŸ”’')
                .fontSize(18)
                .margin({ right: 12 })

              TextInput({ placeholder: 'è¯·å†æ¬¡è¾“å…¥å¯†ç ', text: this.confirmPassword })
                .layoutWeight(1)
                .backgroundColor('transparent')
                .fontSize(FontSizes.body)
                .fontColor(Colors.textPrimary)
                .placeholderColor(Colors.textQuaternary)
                .caretColor(Colors.primary)
                .type(InputType.Password)
                .onChange((value: string) => {
                  this.confirmPassword = value;
                })
            }
            .width('100%')
            .height(Sizes.inputHeight)
            .padding({ left: 16, right: 16 })
            .backgroundColor(Colors.bgSecondary)
            .borderRadius(Radius.input)
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 24 })

          // ç”¨æˆ·åè®®
          Row() {
            Checkbox()
              .select(this.agreeTerms)
              .selectedColor(Colors.primary)
              .onChange((value: boolean) => {
                this.agreeTerms = value;
              })

            Text() {
              Span('æˆ‘å·²é˜…è¯»å¹¶åŒæ„')
                .fontSize(FontSizes.small)
                .fontColor(Colors.textTertiary)
              Span('ã€Šç”¨æˆ·åè®®ã€‹')
                .fontSize(FontSizes.small)
                .fontColor(Colors.primary)
              Span('å’Œ')
                .fontSize(FontSizes.small)
                .fontColor(Colors.textTertiary)
              Span('ã€Šéšç§æ”¿ç­–ã€‹')
                .fontSize(FontSizes.small)
                .fontColor(Colors.primary)
            }
            .margin({ left: 8 })
          }
          .width('100%')

          // æ³¨å†ŒæŒ‰é’®
          Button() {
            Row() {
              if (this.isLoading) {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color(Colors.textWhite)
              } else {
                Text('æ³¨å†Œ')
                  .fontSize(FontSizes.bodyLarge)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(Colors.textWhite)
              }
            }
          }
          .width('100%')
          .height(Sizes.buttonLg)
          .backgroundColor(this.agreeTerms ? Colors.primary : Colors.textQuaternary)
          .borderRadius(Radius.button)
          .shadow({ radius: 12, color: 'rgba(14, 165, 233, 0.3)', offsetY: 4 })
          .margin({ top: 24 })
          .enabled(this.agreeTerms)
          .onClick(() => {
            this.handleRegister();
          })

          // ç™»å½•å…¥å£
          Row() {
            Text('å·²æœ‰è´¦å·ï¼Ÿ')
              .fontSize(FontSizes.bodySmall)
              .fontColor(Colors.textTertiary)
            Text('ç«‹å³ç™»å½•')
              .fontSize(FontSizes.bodySmall)
              .fontColor(Colors.primary)
              .fontWeight(FontWeight.Medium)
              .margin({ left: 4 })
              .onClick(() => {
                router.back();
              })
          }
          .margin({ top: 24, bottom: 48 })
        }
        .width('100%')
        .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.bgPrimary)
  }

  @Builder
  InputField(label: string, icon: string, placeholder: string, value: string, onChange: (value: string) => void) {
    Column() {
      Text(label)
        .fontSize(FontSizes.bodySmall)
        .fontWeight(FontWeight.Medium)
        .fontColor(Colors.textSecondary)
        .margin({ bottom: 8, left: 4 })

      Row() {
        Text(icon)
          .fontSize(18)
          .margin({ right: 12 })

        TextInput({ placeholder: placeholder, text: value })
          .layoutWeight(1)
          .backgroundColor('transparent')
          .fontSize(FontSizes.body)
          .fontColor(Colors.textPrimary)
          .placeholderColor(Colors.textQuaternary)
          .caretColor(Colors.primary)
          .onChange(onChange)
      }
      .width('100%')
      .height(Sizes.inputHeight)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Colors.bgSecondary)
      .borderRadius(Radius.input)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ bottom: 16 })
  }

  sendVerifyCode() {
    if (!this.account) {
      return;
    }
    this.countdown = 60;
    const timer = setInterval(() => {
      this.countdown--;
      if (this.countdown <= 0) {
        clearInterval(timer);
      }
    }, 1000);
  }

  handleRegister() {
    if (!this.nickname || !this.account || !this.verifyCode || !this.password || !this.confirmPassword) {
      return;
    }
    if (this.password !== this.confirmPassword) {
      return;
    }

    this.isLoading = true;
    setTimeout(() => {
      this.isLoading = false;
      router.replaceUrl({ url: 'pages/Index' });
    }, 1500);
  }
}
