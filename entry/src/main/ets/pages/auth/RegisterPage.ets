/**
 * æ³¨å†Œé¡µé¢ - å¯¹æ¥çœŸå® API
 */
import { router } from '@kit.ArkUI';
import { ApiService, AuthData, RegisterParams } from '../../services/ApiService';

@Entry
@Component
struct RegisterPage {
  @State email: string = '';
  @State nickname: string = '';
  @State password: string = '';
  @State confirmPassword: string = '';
  @State isPasswordVisible: boolean = false;
  @State isLoading: boolean = false;
  @State errorMessage: string = '';

  build() {
    Column() {
      Column()
        .width('100%')
        .height('30%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#E0F2FE', 0], ['#F0F9FF', 0.5], ['#FFFFFF', 1]]
        })
        .position({ x: 0, y: 0 })

      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Row() {
          Text('â†')
            .fontSize(28)
            .fontColor('#38BDF8')
            .onClick(() => {
              router.back();
            })
          Blank()
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 48 })

        // æ ‡é¢˜
        Column() {
          Text('åˆ›å»ºè´¦å·')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1E293B')

          Text('å¼€å§‹ä½ çš„æ¢ç´¢ä¹‹æ—…')
            .fontSize(14)
            .fontColor('#94A3B8')
            .margin({ top: 8 })
        }
        .width('100%')
        .padding({ left: 24 })
        .alignItems(HorizontalAlign.Start)
        .margin({ top: 20, bottom: 32 })

        // è¡¨å•
        Scroll() {
          Column() {
            // é”™è¯¯æç¤º
            if (this.errorMessage) {
              Row() {
                Text('âš ï¸')
                  .fontSize(14)
                Text(this.errorMessage)
                  .fontSize(13)
                  .fontColor('#EF4444')
                  .margin({ left: 6 })
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 10, bottom: 10 })
              .backgroundColor('#FEF2F2')
              .borderRadius(10)
              .margin({ bottom: 16 })
            }

            // æ˜µç§°
            this.InputField('æ˜µç§°', 'ğŸ‘¤', 'ç»™è‡ªå·±å–ä¸ªåå­—', this.nickname, InputType.Normal, (v: string) => {
              this.nickname = v;
              this.errorMessage = '';
            })

            // é‚®ç®±
            this.InputField('é‚®ç®±', 'ğŸ“§', 'è¯·è¾“å…¥é‚®ç®±', this.email, InputType.Email, (v: string) => {
              this.email = v;
              this.errorMessage = '';
            })

            // å¯†ç 
            Column() {
              Text('å¯†ç ')
                .fontSize(13)
                .fontWeight(FontWeight.Medium)
                .fontColor('#64748B')
                .margin({ bottom: 10, left: 4 })

              Row() {
                Text('ğŸ”’')
                  .fontSize(18)
                  .margin({ right: 12 })

                TextInput({ placeholder: 'è‡³å°‘6ä½å¯†ç ', text: this.password })
                  .layoutWeight(1)
                  .backgroundColor('transparent')
                  .fontSize(15)
                  .fontColor('#1E293B')
                  .placeholderColor('#CBD5E1')
                  .type(this.isPasswordVisible ? InputType.Normal : InputType.Password)
                  .onChange((v: string) => {
                    this.password = v;
                    this.errorMessage = '';
                  })

                Text(this.isPasswordVisible ? 'ğŸ‘ï¸' : 'ğŸ™ˆ')
                  .fontSize(18)
                  .opacity(0.6)
                  .onClick(() => {
                    this.isPasswordVisible = !this.isPasswordVisible;
                  })
              }
              .width('100%')
              .height(52)
              .padding({ left: 16, right: 16 })
              .backgroundColor('#F8FAFC')
              .borderRadius(14)
            }
            .width('100%')
            .alignItems(HorizontalAlign.Start)
            .margin({ top: 20 })

            // ç¡®è®¤å¯†ç 
            this.InputField('ç¡®è®¤å¯†ç ', 'ğŸ”’', 'å†æ¬¡è¾“å…¥å¯†ç ', this.confirmPassword, InputType.Password, (v: string) => {
              this.confirmPassword = v;
              this.errorMessage = '';
            })

            // æ³¨å†ŒæŒ‰é’®
            Button() {
              Row() {
                if (this.isLoading) {
                  LoadingProgress()
                    .width(24)
                    .height(24)
                    .color('#FFFFFF')
                } else {
                  Text('æ³¨å†Œ')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#FFFFFF')
                  Text('ğŸš€')
                    .fontSize(16)
                    .margin({ left: 8 })
                }
              }
            }
            .width('100%')
            .height(52)
            .backgroundColor(this.canRegister() ? '#38BDF8' : '#CBD5E1')
            .borderRadius(26)
            .margin({ top: 32 })
            .enabled(this.canRegister() && !this.isLoading)
            .onClick(() => {
              this.handleRegister();
            })

            // å·²æœ‰è´¦å·
            Row() {
              Text('å·²æœ‰è´¦å·ï¼Ÿ')
                .fontSize(14)
                .fontColor('#94A3B8')
              Text('å»ç™»å½•')
                .fontSize(14)
                .fontColor('#38BDF8')
                .fontWeight(FontWeight.Bold)
                .margin({ left: 4 })
                .onClick(() => {
                  router.back();
                })
            }
            .margin({ top: 24, bottom: 48 })
          }
          .padding({ left: 24, right: 24 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }

  @Builder
  InputField(label: string, icon: string, placeholder: string, value: string, type: InputType, onChange: (v: string) => void) {
    Column() {
      Text(label)
        .fontSize(13)
        .fontWeight(FontWeight.Medium)
        .fontColor('#64748B')
        .margin({ bottom: 10, left: 4 })

      Row() {
        Text(icon)
          .fontSize(18)
          .margin({ right: 12 })

        TextInput({ placeholder: placeholder, text: value })
          .layoutWeight(1)
          .backgroundColor('transparent')
          .fontSize(15)
          .fontColor('#1E293B')
          .placeholderColor('#CBD5E1')
          .type(type)
          .onChange(onChange)
      }
      .width('100%')
      .height(52)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#F8FAFC')
      .borderRadius(14)
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .margin({ top: 20 })
  }

  private canRegister(): boolean {
    return this.email.trim().length > 0
      && this.nickname.trim().length > 0
      && this.password.length >= 6
      && this.confirmPassword.length > 0;
  }

  private async handleRegister(): Promise<void> {
    // å‰ç«¯æ ¡éªŒ
    if (this.password !== this.confirmPassword) {
      this.errorMessage = 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´';
      return;
    }

    if (this.password.length < 6) {
      this.errorMessage = 'å¯†ç è‡³å°‘6ä½';
      return;
    }

    this.isLoading = true;
    this.errorMessage = '';

    try {
      const params = new RegisterParams();
      params.email = this.email;
      params.password = this.password;
      params.nickname = this.nickname;

      const result: AuthData = await ApiService.register(params);

      // æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•
      AppStorage.setOrCreate('userToken', result.accessToken);
      AppStorage.setOrCreate('currentUserId', result.user.id);
      AppStorage.setOrCreate('currentUserNickname', result.user.nickname);
      AppStorage.setOrCreate('currentUserAvatar', result.user.avatar);
      AppStorage.setOrCreate('currentUserEmail', result.user.email);
      AppStorage.setOrCreate('isLoggedIn', true);

      console.info(`[Register] æ³¨å†ŒæˆåŠŸ: ${result.user.nickname}`);

      router.replaceUrl({ url: 'pages/Index' });

    } catch (error) {
      const err = error as Error;
      this.errorMessage = err.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•';
      console.error(`[Register] æ³¨å†Œå¤±è´¥: ${err.message}`);
    } finally {
      this.isLoading = false;
    }
  }
}