/**
 * ç”¨æˆ·ä¸»é¡µ - å¢å¼ºç‰ˆ
 * æ”¯æŒåŒºåˆ†"è‡ªå·±/ä»–äºº"ï¼Œå¸–å­ç‚¹å‡»è·³è½¬è¯¦æƒ…ï¼Œè§†å·®èƒŒæ™¯å¤´å›¾
 */

import { router } from '@kit.ArkUI';
import { Post } from '../../models/Post';
import { User } from '../../models/User';
import { mockUsers, mockPosts } from '../../services/MockData';

@Entry
@Component
struct UserProfilePage {
  @State user: User | null = null;
  @State userPosts: Post[] = [];
  @State likedPosts: Post[] = [];
  @State isFollowing: boolean = false;
  @State isBlocked: boolean = false;
  @State currentTab: number = 0;
  @State showMoreMenu: boolean = false;
  @State scrollY: number = 0;
  @State isSelf: boolean = false;
  @StorageProp('currentUserId') currentUserId: string = 'user_self';
  private userId: string = '';

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params && params.userId) {
      this.userId = params.userId;
    } else {
      // å¦‚æœæ²¡ä¼  userIdï¼Œé»˜è®¤å½“åšè‡ªå·±çš„ä¸»é¡µ
      this.userId = this.currentUserId;
    }
    this.isSelf = (this.userId === this.currentUserId);
    this.loadUserProfile();
  }

  private loadUserProfile(): void {
    this.user = mockUsers.find(u => u.id === this.userId) || {
      id: this.userId,
      nickname: this.isSelf ? 'æˆ‘' : 'ç”¨æˆ·',
      avatar: '',
      bio: this.isSelf ? 'è®°å½•æ¯ä¸€æ¬¡æ—…é€”ä¸­çš„ç¾å¥½ç¬é—´ âœ¨' : 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~',
      level: this.isSelf ? 5 : 1,
      levelTitle: this.isSelf ? 'æ˜Ÿè¾°æ—…è€…' : 'è¿·é›¾è¡Œè€…',
      followingCount: this.isSelf ? 128 : 0,
      followersCount: this.isSelf ? 2560 : 0,
      friendsCount: this.isSelf ? 36 : 0,
      citiesCount: this.isSelf ? 24 : 0,
      countriesCount: this.isSelf ? 8 : 0,
      postsCount: this.isSelf ? 67 : 0,
      createdAt: '',
      updatedAt: '',
    };

    this.userPosts = mockPosts.filter(p => p.author.id === this.userId);
    if (this.userPosts.length === 0) {
      this.userPosts = mockPosts.slice(0, 3);
    }

    // æ¨¡æ‹Ÿ"å–œæ¬¢"çš„å¸–å­
    this.likedPosts = mockPosts.filter(p => p.isLiked);
    if (this.likedPosts.length === 0) {
      this.likedPosts = mockPosts.slice(1, 4);
    }
  }

  private toggleFollow(): void {
    this.isFollowing = !this.isFollowing;
    if (this.user) {
      // æ¨¡æ‹Ÿç²‰ä¸æ•°å˜åŒ–
      let newFollowerCount = this.user.followersCount;
      if (this.isFollowing) {
        newFollowerCount += 1;
      } else {
        newFollowerCount = Math.max(0, newFollowerCount - 1);
      }

      const newUser: User = {
        id: this.user.id,
        nickname: this.user.nickname,
        avatar: this.user.avatar,
        bio: this.user.bio,
        level: this.user.level,
        levelTitle: this.user.levelTitle,
        followingCount: this.user.followingCount,
        followersCount: newFollowerCount, // æ›´æ–°è¿™ä¸ªå€¼
        friendsCount: this.user.friendsCount,
        citiesCount: this.user.citiesCount,
        countriesCount: this.user.countriesCount,
        postsCount: this.user.postsCount,
        createdAt: this.user.createdAt,
        updatedAt: this.user.updatedAt,
        email: this.user.email,
        phone: this.user.phone
      };

      this.user = newUser;
    }
  }

  private toggleBlock(): void {
    this.isBlocked = !this.isBlocked;
    this.showMoreMenu = false;
  }

  private goBack(): void {
    router.back();
  }

  private sendMessage(): void {
    console.info('[UserProfile] è·³è½¬ç§ä¿¡é¡µé¢');
  }

  private navigateToPostDetail(post: Post): void {
    router.pushUrl({
      url: 'pages/community/PostDetailPage',
      params: { postId: post.id }
    }).catch((err: Error) => {
      console.error(`[UserProfile] è·³è½¬å¤±è´¥: ${err.message}`);
    });
  }

  private navigateToEditProfile(): void {
    console.info('[UserProfile] è·³è½¬ç¼–è¾‘èµ„æ–™é¡µ');
    // TODO: router.pushUrl({ url: 'pages/profile/EditProfilePage' });
  }

  private navigateToSettings(): void {
    router.pushUrl({
      url: 'pages/settings/SettingsPage'
    }).catch((err: Error) => {
      console.error(`[UserProfile] è·³è½¬è®¾ç½®å¤±è´¥: ${err.message}`);
    });
  }

  private formatCount(count: number): string {
    if (count >= 10000) {
      return `${(count / 10000).toFixed(1)}w`;
    } else if (count >= 1000) {
      return `${(count / 1000).toFixed(1)}k`;
    }
    return `${count}`;
  }

  private getCurrentPosts(): Post[] {
    return this.currentTab === 0 ? this.userPosts : this.likedPosts;
  }

  build() {
    Stack() {
      Column() {
        Scroll() {
          Column() {
            // è§†å·®èƒŒæ™¯å°é¢ + ç”¨æˆ·ä¿¡æ¯
            this.CoverAndInfo()

            // æ“ä½œæŒ‰é’®ï¼ˆæ ¹æ®èº«ä»½åˆ‡æ¢ï¼‰
            this.ActionButtons()

            // Tab æ 
            this.ContentTabs()

            // ä½œå“/å–œæ¬¢ç½‘æ ¼
            this.PostsGrid()
          }
          .width('100%')
        }
        .width('100%')
        .height('100%')
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .onScroll((_xOffset: number, yOffset: number) => {
          this.scrollY = Math.max(0, this.scrollY + yOffset);
        })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8FAFC')

      // é¡¶éƒ¨å¯¼èˆªæ ï¼ˆæ»šåŠ¨æ—¶æ¸å˜æ˜¾ç¤ºï¼‰
      this.TopNavBar()

      // æ›´å¤šèœå•å¼¹çª—
      if (this.showMoreMenu) {
        this.MoreMenuOverlay()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  TopNavBar() {
    // æ»šåŠ¨æ—¶å¯¼èˆªæ èƒŒæ™¯æ¸æ˜¾
    Row() {
      Row() {
        Text('â†')
          .fontSize(22)
          .fontColor(this.scrollY > 100 ? '#1E293B' : '#FFFFFF')
          .fontWeight(FontWeight.Bold)
      }
      .width(40)
      .height(40)
      .borderRadius(20)
      .backgroundColor(this.scrollY > 100 ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.2)')
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.goBack())

      Blank()

      // æ»šåŠ¨åæ˜¾ç¤ºç”¨æˆ·å
      if (this.scrollY > 120) {
        Text(this.user?.nickname || '')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1E293B')
      }

      Blank()

      Row() {
        Text(this.isSelf ? 'âš™ï¸' : 'â€¢â€¢â€¢')
          .fontSize(this.isSelf ? 20 : 18)
          .fontColor(this.scrollY > 100 ? '#1E293B' : '#FFFFFF')
          .fontWeight(FontWeight.Bold)
      }
      .width(40)
      .height(40)
      .borderRadius(20)
      .backgroundColor(this.scrollY > 100 ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.2)')
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        if (this.isSelf) {
          this.navigateToSettings();
        } else {
          this.showMoreMenu = !this.showMoreMenu;
        }
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 48, bottom: 8 })
    .backgroundColor(this.scrollY > 100 ? `rgba(255,255,255,${Math.min(1, (this.scrollY - 100) / 60)})` : 'transparent')
    .position({ x: 0, y: 0 })
  }

  @Builder
  CoverAndInfo() {
    Column() {
      // è§†å·®èƒŒæ™¯å°é¢
      Stack() {
        // ä¸»æ¸å˜èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: this.isSelf
              ? [['#0C4A6E', 0], ['#0369A1', 0.4], ['#0EA5E9', 0.8], ['#38BDF8', 1]]
              : [['#1E293B', 0], ['#334155', 0.5], ['#64748B', 1]]
          })

        // è£…é¥°å…‰æ•ˆ1 - å¤§åœ†
        Column()
          .width(200)
          .height(200)
          .borderRadius(100)
          .backgroundColor(this.isSelf ? '#7DD3FC' : '#94A3B8')
          .opacity(0.15)
          .blur(60)
          .position({ x: '60%', y: 10 })
          .translate({ y: -this.scrollY * 0.3 }) // è§†å·®æ•ˆæœ

        // è£…é¥°å…‰æ•ˆ2 - å°åœ†
        Column()
          .width(140)
          .height(140)
          .borderRadius(70)
          .backgroundColor(this.isSelf ? '#BAE6FD' : '#CBD5E1')
          .opacity(0.12)
          .blur(50)
          .position({ x: '5%', y: 50 })
          .translate({ y: -this.scrollY * 0.2 }) // è§†å·®æ•ˆæœ

        // è£…é¥°å…‰æ•ˆ3 - å³ä¸‹è§’å°ç‚¹
        Column()
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor('#E0F2FE')
          .opacity(0.1)
          .blur(30)
          .position({ x: '80%', y: 120 })
          .translate({ y: -this.scrollY * 0.15 })

        // ç½‘æ ¼è£…é¥°çº¿ï¼ˆæ¨¡æ‹Ÿåœ°å›¾ç»çº¬çº¿ï¼‰
        Column()
          .width('100%')
          .height('100%')
          .opacity(0.05)
          .border({
            width: 1,
            color: '#FFFFFF'
          })
      }
      .width('100%')
      .height(220)
      .clip(true)

      // ç”¨æˆ·ä¿¡æ¯åŒº
      Column() {
        // å¤´åƒ
        Stack() {
          // å¤–åœˆå…‰ç¯
          Column()
            .width(92)
            .height(92)
            .borderRadius(46)
            .linearGradient({
              direction: GradientDirection.RightBottom,
              colors: this.isSelf
                ? [['#38BDF8', 0], ['#0EA5E9', 0.5], ['#0284C7', 1]]
                : [['#64748B', 0], ['#94A3B8', 1]]
            })

          // å¤´åƒä¸»ä½“
          Column() {
            Text((this.user?.nickname || 'U').charAt(0))
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
          }
          .width(82)
          .height(82)
          .borderRadius(41)
          .backgroundColor(this.isSelf ? '#0EA5E9' : '#64748B')
          .border({ width: 3, color: '#FFFFFF' })
          .justifyContent(FlexAlign.Center)

          // ç­‰çº§å¾½ç« 
          Row() {
            Text(`LV.${this.user?.level || 1}`)
              .fontSize(9)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
          }
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .backgroundColor(this.isSelf ? '#0EA5E9' : '#64748B')
          .borderRadius(10)
          .border({ width: 2, color: '#FFFFFF' })
          .position({ x: 58, y: 72 })

          // è‡ªå·±ä¸»é¡µ - å¤´åƒå³ä¸‹è§’ç›¸æœºå›¾æ ‡
          if (this.isSelf) {
            Column() {
              Text('ğŸ“·')
                .fontSize(12)
            }
            .width(24)
            .height(24)
            .borderRadius(12)
            .backgroundColor('#38BDF8')
            .border({ width: 2, color: '#FFFFFF' })
            .justifyContent(FlexAlign.Center)
            .position({ x: 62, y: 2 })
            .onClick(() => {
              console.info('[UserProfile] æ›´æ¢å¤´åƒ');
            })
          }
        }
        .width(92)
        .height(92)
        .margin({ top: -46 })

        // æ˜µç§°
        Row() {
          Text(this.user?.nickname || 'ç”¨æˆ·')
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1E293B')

          if (this.isSelf) {
            Text('ï¼ˆæˆ‘ï¼‰')
              .fontSize(14)
              .fontColor('#94A3B8')
              .margin({ left: 4 })
          }
        }
        .margin({ top: 12 })

        // ç§°å·æ ‡ç­¾
        Row() {
          Text('ğŸŒ')
            .fontSize(12)
          Text(this.user?.levelTitle || 'è¿·é›¾è¡Œè€…')
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .fontColor('#0EA5E9')
            .margin({ left: 4 })
        }
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor('#E0F2FE')
        .borderRadius(12)
        .margin({ top: 8 })

        // ç®€ä»‹
        Text(this.user?.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~')
          .fontSize(14)
          .fontColor('#64748B')
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 10 })
          .padding({ left: 32, right: 32 })

        // ç»Ÿè®¡æ•°æ®
        Row() {
          this.StatColumn(this.formatCount(this.user?.followingCount || 0), 'å…³æ³¨')
          Column().width(1).height(24).backgroundColor('#E2E8F0')
          this.StatColumn(this.formatCount(this.user?.followersCount || 0), 'ç²‰ä¸')
          Column().width(1).height(24).backgroundColor('#E2E8F0')
          this.StatColumn(this.formatCount(this.user?.citiesCount || 0), 'åŸå¸‚')
          Column().width(1).height(24).backgroundColor('#E2E8F0')
          this.StatColumn(`${this.user?.countriesCount || 0}`, 'å›½å®¶')
        }
        .width('100%')
        .padding({ top: 20, bottom: 16 })
        .justifyContent(FlexAlign.SpaceEvenly)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .backgroundColor('#FFFFFF')
    }
  }

  @Builder
  StatColumn(value: string, label: string) {
    Column() {
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1E293B')
      Text(label)
        .fontSize(12)
        .fontColor('#94A3B8')
        .margin({ top: 2 })
    }
    .alignItems(HorizontalAlign.Center)
    .layoutWeight(1)
  }

  @Builder
  ActionButtons() {
    if (this.isSelf) {
      // è‡ªå·±çš„ä¸»é¡µ - ç¼–è¾‘èµ„æ–™ + è®¾ç½®
      Row({ space: 12 }) {
        Button() {
          Row() {
            Text('âœï¸')
              .fontSize(14)
            Text('ç¼–è¾‘èµ„æ–™')
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor('#0EA5E9')
              .margin({ left: 6 })
          }
        }
        .height(44)
        .layoutWeight(1)
        .backgroundColor('#E0F2FE')
        .borderRadius(24)
        .onClick(() => this.navigateToEditProfile())

        Button() {
          Row() {
            Text('âš™ï¸')
              .fontSize(14)
            Text('è®¾ç½®')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#475569')
              .margin({ left: 6 })
          }
        }
        .height(44)
        .width(100)
        .backgroundColor('#F1F5F9')
        .borderRadius(24)
        .onClick(() => this.navigateToSettings())
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 16 })
    } else {
      // åˆ«äººçš„ä¸»é¡µ - å…³æ³¨ + ç§ä¿¡
      Row({ space: 12 }) {
        Button() {
          Row() {
            if (this.isFollowing) {
              Text('âœ“')
                .fontSize(14)
                .fontColor('#64748B')
            }
            Text(this.isFollowing ? ' å·²å…³æ³¨' : '+ å…³æ³¨')
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.isFollowing ? '#64748B' : '#FFFFFF')
          }
        }
        .height(44)
        .layoutWeight(1)
        .backgroundColor(this.isFollowing ? '#F1F5F9' : '#38BDF8')
        .borderRadius(24)
        .onClick(() => this.toggleFollow())

        Button() {
          Row() {
            Text('ğŸ’¬')
              .fontSize(14)
            Text('ç§ä¿¡')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#475569')
              .margin({ left: 6 })
          }
        }
        .height(44)
        .layoutWeight(1)
        .backgroundColor('#F1F5F9')
        .borderRadius(24)
        .onClick(() => this.sendMessage())
      }
      .width('100%')
      .padding({ left: 20, right: 20, bottom: 16 })
    }
  }

  @Builder
  ContentTabs() {
    Row() {
      this.TabButton('ä½œå“', 0, `${this.userPosts.length}`)
      this.TabButton('å–œæ¬¢', 1, `${this.likedPosts.length}`)
      if (this.isSelf) {
        this.TabButton('æ”¶è—', 2, '0')
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
    .border({ width: { bottom: 1 }, color: '#F1F5F9' })
  }

  @Builder
  TabButton(title: string, index: number, count: string) {
    Column() {
      Row() {
        Text(title)
          .fontSize(15)
          .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Medium)
          .fontColor(this.currentTab === index ? '#0EA5E9' : '#94A3B8')

        Text(` ${count}`)
          .fontSize(11)
          .fontColor(this.currentTab === index ? '#38BDF8' : '#CBD5E1')
      }

      if (this.currentTab === index) {
        Column()
          .width(24)
          .height(3)
          .borderRadius(1.5)
          .backgroundColor('#38BDF8')
          .margin({ top: 8 })
      } else {
        Column().height(11)
      }
    }
    .layoutWeight(1)
    .padding({ top: 14, bottom: 6 })
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.currentTab = index;
    })
  }

  @Builder
  PostsGrid() {
    Column() {
      if (this.currentTab === 2) {
        // æ”¶è— Tab - ç©ºçŠ¶æ€
        Column() {
          Text('â­')
            .fontSize(48)
          Text('æš‚æ— æ”¶è—')
            .fontSize(14)
            .fontColor('#94A3B8')
            .margin({ top: 12 })
          Text('æµè§ˆç¤¾åŒºæ—¶æ”¶è—å–œæ¬¢çš„å†…å®¹')
            .fontSize(12)
            .fontColor('#CBD5E1')
            .margin({ top: 4 })
        }
        .width('100%')
        .padding({ top: 60 })
        .alignItems(HorizontalAlign.Center)
      } else {
        // ä½œå“ / å–œæ¬¢ Tab
        this.PostGridContent(this.getCurrentPosts())
      }
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
  }

  @Builder
  PostGridContent(posts: Post[]) {
    if (posts.length === 0) {
      Column() {
        Text('ğŸ“­')
          .fontSize(48)
        Text(this.currentTab === 0 ? 'æš‚æ— ä½œå“' : 'æš‚æ— å–œæ¬¢çš„å†…å®¹')
          .fontSize(14)
          .fontColor('#94A3B8')
          .margin({ top: 12 })
        if (this.isSelf && this.currentTab === 0) {
          Button('å»å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .backgroundColor('#38BDF8')
            .borderRadius(20)
            .height(36)
            .margin({ top: 16 })
            .onClick(() => {
              router.pushUrl({ url: 'pages/publish/PublishPostPage' })
                .catch((err: Error) => {
                  console.error(`è·³è½¬å¤±è´¥: ${err.message}`);
                });
            })
        }
      }
      .width('100%')
      .padding({ top: 60 })
      .alignItems(HorizontalAlign.Center)
    } else {
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(posts, (post: Post, index: number) => {
          Stack() {
            // æ¸å˜èƒŒæ™¯ï¼ˆæ¨¡æ‹Ÿå°é¢å›¾ï¼‰
            Column()
              .width('100%')
              .aspectRatio(1)
              .linearGradient({
                direction: GradientDirection.RightBottom,
                colors: [
                  [this.getColor(index), 0],
                  [this.getColorEnd(index), 1]
                ]
              })

            // å¸–å­å†…å®¹é¢„è§ˆï¼ˆå·¦ä¸‹è§’ï¼‰
            Column() {
              Text(post.content)
                .fontSize(10)
                .fontColor('#FFFFFF')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%')
            .padding({ left: 6, right: 6, bottom: 24 })
            .position({ x: 0, y: '55%' })

            // åº•éƒ¨ä¿¡æ¯æ 
            Row() {
              // å›¾ç‰‡æ•°é‡æ ‡è®°
              if (post.images.length > 1) {
                Row() {
                  Text('ğŸ–¼ï¸')
                    .fontSize(8)
                  Text(`${post.images.length}`)
                    .fontSize(9)
                    .fontColor('#FFFFFF')
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 2 })
                }
                .padding({ left: 4, right: 4, top: 2, bottom: 2 })
                .backgroundColor('rgba(0,0,0,0.4)')
                .borderRadius(6)
              }

              Blank()

              // ç‚¹èµæ•°
              Row() {
                Text('â¤ï¸')
                  .fontSize(8)
                Text(`${this.formatCount(post.likeCount)}`)
                  .fontSize(9)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FFFFFF')
                  .margin({ left: 2 })
              }
              .padding({ left: 4, right: 4, top: 2, bottom: 2 })
              .backgroundColor('rgba(0,0,0,0.4)')
              .borderRadius(6)
            }
            .width('100%')
            .padding({ left: 6, right: 6, bottom: 6 })
            .position({ x: 0, y: '100%' })
            .translate({ y: -28 })
          }
          .width('33.33%')
          .aspectRatio(1)
          .padding(0.5)
          .clip(true)
          .onClick(() => this.navigateToPostDetail(post))
        }, (post: Post, index: number) => `${post.id}_${index}`)
      }
    }
  }

  @Builder
  MoreMenuOverlay() {
    Stack() {
      // é®ç½©
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .onClick(() => {
          this.showMoreMenu = false;
        })

      // èœå•é¢æ¿
      Column() {
        Column() {
          this.MenuItem('âš ï¸', this.isBlocked ? 'å–æ¶ˆæ‹‰é»‘' : 'æ‹‰é»‘è¯¥ç”¨æˆ·',
            this.isBlocked ? '#0EA5E9' : '#EF4444',
            () => this.toggleBlock())
          Divider().strokeWidth(0.5).color('#F1F5F9')
          this.MenuItem('ğŸš«', 'ä¸¾æŠ¥', '#EF4444', () => {
            this.showMoreMenu = false;
          })
          Divider().strokeWidth(0.5).color('#F1F5F9')
          this.MenuItem('ğŸ”—', 'å¤åˆ¶ä¸»é¡µé“¾æ¥', '#475569', () => {
            this.showMoreMenu = false;
          })
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
        .borderRadius(16)

        // å–æ¶ˆæŒ‰é’®
        Column() {
          Text('å–æ¶ˆ')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#64748B')
        }
        .width('100%')
        .height(52)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .margin({ top: 8 })
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .onClick(() => {
          this.showMoreMenu = false;
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16 })
      .position({ x: 0, y: '100%' })
      .translate({ y: -220 })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  @Builder
  MenuItem(icon: string, title: string, textColor: string, action: () => void) {
    Row() {
      Text(icon)
        .fontSize(18)
      Text(title)
        .fontSize(15)
        .fontColor(textColor)
        .margin({ left: 12 })
    }
    .width('100%')
    .height(52)
    .padding({ left: 20 })
    .alignItems(VerticalAlign.Center)
    .onClick(action)
  }

  private getColor(index: number): string {
    const colors: string[] = ['#BAE6FD', '#E0F2FE', '#A5F3FC', '#CFFAFE', '#BAE6FD', '#F0F9FF', '#E0F2FE', '#A5F3FC'];
    return colors[index % colors.length];
  }

  private getColorEnd(index: number): string {
    const colors: string[] = ['#0EA5E9', '#0284C7', '#06B6D4', '#0891B2', '#38BDF8', '#0369A1', '#0EA5E9', '#0891B2'];
    return colors[index % colors.length];
  }
}