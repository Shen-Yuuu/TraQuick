/**
 * ç”¨æˆ·ä¸»é¡µ - æŠ–éŸ³é£æ ¼
 * ç‚¹å‡»å¤´åƒè·³è½¬è‡³æ­¤ï¼Œå¯æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯ã€ä½œå“ï¼Œæ”¯æŒå…³æ³¨/æ‹‰é»‘
 */

import { Colors, FontSizes, Spacing, Radius } from '../../utils/Constants';
import { Post } from '../../models/Post';
import { User } from '../../models/User';
import { mockUsers, mockPosts } from '../../services/MockData';
import { router } from '@kit.ArkUI';

@Entry
@Component
struct UserProfilePage {
  @State user: User | null = null;
  @State userPosts: Post[] = [];
  @State isFollowing: boolean = false;
  @State isBlocked: boolean = false;
  @State currentTab: number = 0; // 0: ä½œå“, 1: å–œæ¬¢
  @State showMoreMenu: boolean = false;
  @State headerOpacity: number = 0;
  private userId: string = '';

  aboutToAppear(): void {
    const params = router.getParams() as Record<string, string>;
    if (params && params.userId) {
      this.userId = params.userId;
    }
    this.loadUserProfile();
  }

  private loadUserProfile(): void {
    this.user = mockUsers.find(u => u.id === this.userId) || {
      id: this.userId,
      nickname: 'ç”¨æˆ·',
      avatar: '',
      bio: 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~',
      level: 1,
      levelTitle: 'è¿·é›¾è¡Œè€…',
      followingCount: 0,
      followersCount: 0,
      friendsCount: 0,
      citiesCount: 0,
      countriesCount: 0,
      postsCount: 0,
      createdAt: '',
      updatedAt: '',
    };
    this.userPosts = mockPosts.filter(p => p.author.id === this.userId);
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯¥ç”¨æˆ·çš„å¸–å­ï¼Œå±•ç¤ºä¸€äº›æ¨¡æ‹Ÿæ•°æ®
    if (this.userPosts.length === 0) {
      this.userPosts = mockPosts.slice(0, 3);
    }
  }

  private toggleFollow(): void {
    this.isFollowing = !this.isFollowing;
  }

  private toggleBlock(): void {
    this.isBlocked = !this.isBlocked;
    this.showMoreMenu = false;
  }

  private goBack(): void {
    router.back();
  }

  private sendMessage(): void {
    // TODO: è·³è½¬ç§ä¿¡é¡µé¢
  }

  private navigateToPostDetail(post: Post): void {
    router.pushUrl({
      url: 'pages/community/PostDetailPage',
      params: { postId: post.id }
    }).catch(() => {});
  }

  private formatCount(count: number): string {
    if (count >= 10000) {
      return `${(count / 10000).toFixed(1)}w`;
    } else if (count >= 1000) {
      return `${(count / 1000).toFixed(1)}k`;
    }
    return `${count}`;
  }

  build() {
    Stack() {
      Column() {
        Scroll() {
          Column() {
            // å°é¢èƒŒæ™¯ + ç”¨æˆ·ä¿¡æ¯
            this.CoverAndInfo()

            // æ“ä½œæŒ‰é’®
            this.ActionButtons()

            // Tabæ 
            this.ContentTabs()

            // ä½œå“ç½‘æ ¼
            this.PostsGrid()
          }
          .width('100%')
        }
        .width('100%')
        .height('100%')
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8FAFC')

      // é¡¶éƒ¨å¯¼èˆªæ 
      this.TopNavBar()

      // æ›´å¤šèœå•å¼¹çª—
      if (this.showMoreMenu) {
        this.MoreMenuOverlay()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  TopNavBar() {
    Row() {
      Row() {
        Text('â†')
          .fontSize(22)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
      }
      .width(40)
      .height(40)
      .borderRadius(20)
      .backgroundColor('rgba(0,0,0,0.2)')
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.goBack())

      Blank()

      Row() {
        Text('â€¢â€¢â€¢')
          .fontSize(18)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
      }
      .width(40)
      .height(40)
      .borderRadius(20)
      .backgroundColor('rgba(0,0,0,0.2)')
      .justifyContent(FlexAlign.Center)
      .onClick(() => {
        this.showMoreMenu = !this.showMoreMenu;
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, top: 48 })
    .position({ x: 0, y: 0 })
  }

  @Builder
  CoverAndInfo() {
    Column() {
      // å°é¢èƒŒæ™¯
      Stack() {
        Column()
          .width('100%')
          .height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#0C4A6E', 0], ['#0369A1', 0.5], ['#38BDF8', 1]]
          })

        // è£…é¥°å…‰æ•ˆ
        Column()
          .width(180)
          .height(180)
          .borderRadius(90)
          .backgroundColor('#7DD3FC')
          .opacity(0.15)
          .blur(60)
          .position({ x: '65%', y: 20 })

        Column()
          .width(120)
          .height(120)
          .borderRadius(60)
          .backgroundColor('#BAE6FD')
          .opacity(0.1)
          .blur(40)
          .position({ x: '10%', y: 60 })
      }
      .width('100%')
      .height(200)

      // ç”¨æˆ·ä¿¡æ¯åŒº
      Column() {
        // å¤´åƒ
        Stack() {
          Column()
            .width(88)
            .height(88)
            .borderRadius(44)
            .linearGradient({
              direction: GradientDirection.RightBottom,
              colors: [['#38BDF8', 0], ['#0EA5E9', 1]]
            })

          Column() {
            Text((this.user?.nickname || 'U').charAt(0))
              .fontSize(32)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')
          }
          .width(80)
          .height(80)
          .borderRadius(40)
          .backgroundColor('#0EA5E9')
          .border({ width: 3, color: '#FFFFFF' })
          .justifyContent(FlexAlign.Center)

          // ç­‰çº§
          Text(`LV.${this.user?.level || 1}`)
            .fontSize(9)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .backgroundColor('#0EA5E9')
            .borderRadius(10)
            .border({ width: 2, color: '#FFFFFF' })
            .position({ x: 56, y: 70 })
        }
        .width(88)
        .height(88)
        .margin({ top: -44 })

        // æ˜µç§°
        Text(this.user?.nickname || 'ç”¨æˆ·')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1E293B')
          .margin({ top: 12 })

        // ç§°å·
        Row() {
          Text('ğŸŒ')
            .fontSize(12)
          Text(this.user?.levelTitle || 'è¿·é›¾è¡Œè€…')
            .fontSize(12)
            .fontWeight(FontWeight.Medium)
            .fontColor('#0EA5E9')
            .margin({ left: 4 })
        }
        .padding({ left: 10, right: 10, top: 4, bottom: 4 })
        .backgroundColor('#E0F2FE')
        .borderRadius(12)
        .margin({ top: 8 })

        // ç®€ä»‹
        Text(this.user?.bio || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™~')
          .fontSize(14)
          .fontColor('#64748B')
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .margin({ top: 10 })
          .padding({ left: 32, right: 32 })

        // ç»Ÿè®¡æ•°æ®
        Row() {
          this.StatColumn(this.formatCount(this.user?.followingCount || 0), 'å…³æ³¨')
          Column()
            .width(1)
            .height(24)
            .backgroundColor('#E2E8F0')
          this.StatColumn(this.formatCount(this.user?.followersCount || 0), 'ç²‰ä¸')
          Column()
            .width(1)
            .height(24)
            .backgroundColor('#E2E8F0')
          this.StatColumn(this.formatCount(this.user?.citiesCount || 0), 'åŸå¸‚')
          Column()
            .width(1)
            .height(24)
            .backgroundColor('#E2E8F0')
          this.StatColumn(`${this.user?.countriesCount || 0}`, 'å›½å®¶')
        }
        .width('100%')
        .padding({ top: 20, bottom: 16 })
        .justifyContent(FlexAlign.SpaceEvenly)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
  }

  @Builder
  StatColumn(value: string, label: string) {
    Column() {
      Text(value)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1E293B')
      Text(label)
        .fontSize(12)
        .fontColor('#94A3B8')
        .margin({ top: 2 })
    }
    .alignItems(HorizontalAlign.Center)
    .layoutWeight(1)
  }

  @Builder
  ActionButtons() {
    Row({ space: 12 }) {
      // å…³æ³¨æŒ‰é’®
      Button(this.isFollowing ? 'å·²å…³æ³¨' : '+ å…³æ³¨')
        .fontSize(15)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.isFollowing ? '#64748B' : '#FFFFFF')
        .backgroundColor(this.isFollowing ? '#F1F5F9' : '#38BDF8')
        .borderRadius(24)
        .height(44)
        .layoutWeight(1)
        .onClick(() => this.toggleFollow())

      // ç§ä¿¡æŒ‰é’®
      Button('ğŸ’¬ ç§ä¿¡')
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor('#475569')
        .backgroundColor('#F1F5F9')
        .borderRadius(24)
        .height(44)
        .layoutWeight(1)
        .onClick(() => this.sendMessage())
    }
    .width('100%')
    .padding({ left: 20, right: 20, bottom: 16 })
  }

  @Builder
  ContentTabs() {
    Row() {
      this.TabButton('ä½œå“', 0)
      this.TabButton('å–œæ¬¢', 1)
    }
    .width('100%')
    .padding({ left: 20, right: 20 })
    .border({ width: { bottom: 1 }, color: '#F1F5F9' })
  }

  @Builder
  TabButton(title: string, index: number) {
    Column() {
      Text(title)
        .fontSize(15)
        .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Medium)
        .fontColor(this.currentTab === index ? '#0EA5E9' : '#94A3B8')

      if (this.currentTab === index) {
        Column()
          .width(24)
          .height(3)
          .borderRadius(1.5)
          .backgroundColor('#38BDF8')
          .margin({ top: 8 })
      } else {
        Column().height(11)
      }
    }
    .layoutWeight(1)
    .padding({ top: 14, bottom: 6 })
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.currentTab = index;
    })
  }

  @Builder
  PostsGrid() {
    Column() {
      if (this.userPosts.length === 0) {
        Column() {
          Text('ğŸ“­')
            .fontSize(48)
          Text('æš‚æ— ä½œå“')
            .fontSize(14)
            .fontColor('#94A3B8')
            .margin({ top: 12 })
        }
        .width('100%')
        .padding({ top: 60 })
        .alignItems(HorizontalAlign.Center)
      } else {
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(this.userPosts, (post: Post, index: number) => {
            Stack() {
              Column()
                .width('100%')
                .aspectRatio(1)
                .linearGradient({
                  direction: GradientDirection.RightBottom,
                  colors: [
                    [this.getColor(index), 0],
                    [this.getColorEnd(index), 1]
                  ]
                })

              // åº•éƒ¨ä¿¡æ¯
              Row() {
                Text('â¤ï¸')
                  .fontSize(10)
                Text(`${this.formatCount(post.likeCount)}`)
                  .fontSize(10)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FFFFFF')
                  .margin({ left: 2 })
              }
              .padding({ left: 6, right: 6, top: 3, bottom: 3 })
              .backgroundColor('rgba(0,0,0,0.4)')
              .borderRadius(8)
              .position({ x: 6, y: '85%' })
            }
            .width('33.33%')
            .aspectRatio(1)
            .padding(0.5)
            .onClick(() => this.navigateToPostDetail(post))
          })
        }
      }
    }
    .width('100%')
    .padding(1)
    .backgroundColor('#FFFFFF')
  }

  @Builder
  MoreMenuOverlay() {
    Column() {
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .onClick(() => {
          this.showMoreMenu = false;
        })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })

    // èœå•é¢æ¿
    Column() {
      this.MenuItem('âš ï¸', this.isBlocked ? 'å–æ¶ˆæ‹‰é»‘' : 'æ‹‰é»‘è¯¥ç”¨æˆ·', () => this.toggleBlock())
      Divider().strokeWidth(0.5).color('#F1F5F9')
      this.MenuItem('ğŸš«', 'ä¸¾æŠ¥', () => {
        this.showMoreMenu = false;
      })
      Divider().strokeWidth(0.5).color('#F1F5F9')
      this.MenuItem('ğŸ”—', 'å¤åˆ¶ä¸»é¡µé“¾æ¥', () => {
        this.showMoreMenu = false;
      })

      // å–æ¶ˆæŒ‰é’®
      Column() {
        Text('å–æ¶ˆ')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#64748B')
      }
      .width('100%')
      .height(52)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
      .margin({ top: 8 })
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .onClick(() => {
        this.showMoreMenu = false;
      })
    }
    .width('100%')
    .padding({ left: 16, right: 16, bottom: 34 })
    .position({ x: 0, y: '100%' })
    .translate({ y: -200 })
  }

  @Builder
  MenuItem(icon: string, title: string, action: () => void) {
    Row() {
      Text(icon)
        .fontSize(18)
      Text(title)
        .fontSize(15)
        .fontColor('#1E293B')
        .margin({ left: 12 })
    }
    .width('100%')
    .height(52)
    .padding({ left: 20 })
    .alignItems(VerticalAlign.Center)
    .backgroundColor('#FFFFFF')
    .onClick(action)
  }

  private getColor(index: number): string {
    const colors = ['#BAE6FD', '#E0F2FE', '#A5F3FC', '#CFFAFE', '#BAE6FD', '#F0F9FF', '#E0F2FE', '#A5F3FC'];
    return colors[index % colors.length];
  }

  private getColorEnd(index: number): string {
    const colors = ['#0EA5E9', '#0284C7', '#06B6D4', '#0891B2', '#38BDF8', '#0369A1', '#0EA5E9', '#0891B2'];
    return colors[index % colors.length];
  }
}
