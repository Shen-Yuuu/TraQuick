/**
 * æ—¶ç©ºèƒ¶å›Šé¡µé¢ - åŸ‹ä¸‹ä¸ŽæŒ–æŽ˜
 */

import { Colors, FontSizes, Spacing, Radius } from '../../utils/Constants';
import { router } from '@kit.ArkUI';

interface TimeCapsule {
  id: string;
  content: string;
  images: string[];
  targetDate: string;      // è§£å°æ—¥æœŸ
  createdAt: string;
  location: CapsuleLocation;
  status: 'locked' | 'unlocked';
}

interface CapsuleLocation {
  cityName: string;
  address: string;
}

@Entry
@Component
struct TimeCapsulePage {
  @State currentTab: number = 0;  // 0: åŸ‹ä¸‹èƒ¶å›Š, 1: æˆ‘çš„èƒ¶å›Š
  @State content: string = '';
  @State targetDate: string = '';
  @State myCapsules: TimeCapsule[] = [];

  private tabs: string[] = ['åŸ‹ä¸‹èƒ¶å›Š', 'æˆ‘çš„èƒ¶å›Š'];

  aboutToAppear(): void {
    this.loadMyCapsules();
    // é»˜è®¤è®¾ç½®ä¸ºä¸€å¹´åŽ
    const nextYear = new Date();
    nextYear.setFullYear(nextYear.getFullYear() + 1);
    this.targetDate = nextYear.toISOString().split('T')[0];
  }

  // åŠ è½½æˆ‘çš„èƒ¶å›Š
  private loadMyCapsules(): void {
    this.myCapsules = [
      {
        id: 'capsule_001',
        content: 'å¸Œæœ›æ˜Žå¹´çš„è‡ªå·±å·²ç»å®žçŽ°äº†çŽ¯çƒæ—…è¡Œçš„æ¢¦æƒ³ï¼',
        images: [],
        targetDate: '2025-12-31',
        createdAt: new Date(Date.now() - 30 * 86400000).toISOString(),
        location: { cityName: 'åŒ—äº¬', address: 'å›½è´¸' },
        status: 'locked',
      },
      {
        id: 'capsule_002',
        content: 'ä»Šå¤©æ˜¯æ¯•ä¸šæ—…è¡Œçš„æœ€åŽä¸€å¤©ï¼Œå’Œæœ€å¥½çš„æœ‹å‹ä»¬ä¸€èµ·...',
        images: [],
        targetDate: '2024-06-01',
        createdAt: new Date(Date.now() - 365 * 86400000).toISOString(),
        location: { cityName: 'åŽ¦é—¨', address: 'é¼“æµªå±¿' },
        status: 'unlocked',
      },
    ];
  }

  // åŸ‹ä¸‹èƒ¶å›Š
  private buryCapusle(): void {
    if (!this.content.trim()) return;

    const newCapsule: TimeCapsule = {
      id: `capsule_${Date.now()}`,
      content: this.content,
      images: [],
      targetDate: this.targetDate,
      createdAt: new Date().toISOString(),
      location: { cityName: 'åŒ—äº¬', address: 'å½“å‰ä½ç½®' },
      status: 'locked',
    };
    this.myCapsules = [newCapsule, ...this.myCapsules];
    this.content = '';
    this.currentTab = 1;  // åˆ‡æ¢åˆ°æˆ‘çš„èƒ¶å›Š
  }

  // è¿”å›ž
  private goBack(): void {
    router.back();
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  private formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  // è®¡ç®—å‰©ä½™å¤©æ•°
  private getDaysRemaining(targetDate: string): number {
    const target = new Date(targetDate);
    const now = new Date();
    const diff = target.getTime() - now.getTime();
    return Math.max(0, Math.ceil(diff / 86400000));
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      this.NavigationBar()

      // Tabæ 
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.BuryContent()
      } else {
        this.MyCapsulesContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.bgSecondary)
  }

  @Builder
  NavigationBar() {
    Row() {
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor(Colors.textPrimary)
      }
      .width(44)
      .height(44)
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.goBack())

      Blank()

      Text('æ—¶ç©ºèƒ¶å›Š')
        .fontSize(FontSizes.body)
        .fontWeight(FontWeight.Bold)
        .fontColor(Colors.textPrimary)

      Blank()

      Row().width(44).height(44)
    }
    .width('100%')
    .height(56)
    .padding({ left: 4, right: 4, top: 48 })
    .backgroundColor(Colors.bgPrimary)
  }

  @Builder
  TabBar() {
    Row() {
      ForEach(this.tabs, (tab: string, index: number) => {
        Column() {
          Text(tab)
            .fontSize(FontSizes.body)
            .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)
            .fontColor(this.currentTab === index ? Colors.primary : Colors.textTertiary)
            .onClick(() => {
              this.currentTab = index;
            })

          if (this.currentTab === index) {
            Row()
              .width(24)
              .height(3)
              .backgroundColor(Colors.primary)
              .borderRadius(2)
              .margin({ top: 8 })
          } else {
            Row().height(11)
          }
        }
      })
    }
    .width('100%')
    .height(56)
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Colors.bgPrimary)
  }

  @Builder
  BuryContent() {
    Scroll() {
      Column() {
        // èƒ¶å›Šå›¾æ ‡
        Column() {
          Text('ðŸ’Š')
            .fontSize(64)
          Text('å†™ç»™æœªæ¥çš„è‡ªå·±')
            .fontSize(FontSizes.h4)
            .fontWeight(FontWeight.Bold)
            .fontColor(Colors.textPrimary)
            .margin({ top: 16 })
          Text('è¿™å°ä¿¡å°†åœ¨æŒ‡å®šæ—¥æœŸè§£å°')
            .fontSize(FontSizes.bodySmall)
            .fontColor(Colors.textTertiary)
            .margin({ top: 8 })
        }
        .width('100%')
        .padding({ top: 32, bottom: 32 })

        // å†…å®¹è¾“å…¥
        Column() {
          Text('å†™ä¸‹ä½ æƒ³è¯´çš„è¯')
            .fontSize(FontSizes.bodySmall)
            .fontWeight(FontWeight.Bold)
            .fontColor(Colors.textPrimary)
            .width('100%')
            .margin({ bottom: 12 })

          TextArea({ placeholder: 'å†™ç»™æœªæ¥çš„è‡ªå·±ï¼Œæˆ–è€…è®°å½•æ­¤åˆ»çš„å¿ƒæƒ…...', text: this.content })
            .width('100%')
            .height(180)
            .fontSize(FontSizes.body)
            .backgroundColor(Colors.bgPrimary)
            .borderRadius(Radius.card)
            .padding(16)
            .onChange((value: string) => {
              this.content = value;
            })
        }
        .width('100%')
        .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding })

        // è§£å°æ—¥æœŸ
        Column() {
          Text('é€‰æ‹©è§£å°æ—¥æœŸ')
            .fontSize(FontSizes.bodySmall)
            .fontWeight(FontWeight.Bold)
            .fontColor(Colors.textPrimary)
            .width('100%')
            .margin({ bottom: 12 })

          Row() {
            Text('ðŸ“…')
              .fontSize(20)
            Text(this.formatDate(this.targetDate))
              .fontSize(FontSizes.body)
              .fontColor(Colors.textPrimary)
              .margin({ left: 12 })
            Blank()
            Text(`è¿˜æœ‰ ${this.getDaysRemaining(this.targetDate)} å¤©`)
              .fontSize(FontSizes.small)
              .fontColor(Colors.primary)
          }
          .width('100%')
          .height(56)
          .padding({ left: 16, right: 16 })
          .backgroundColor(Colors.bgPrimary)
          .borderRadius(Radius.card)

          // å¿«æ·é€‰æ‹©
          Row() {
            ForEach(['1å¹´åŽ', '2å¹´åŽ', '5å¹´åŽ', '10å¹´åŽ'], (label: string, index: number) => {
              Text(label)
                .fontSize(FontSizes.small)
                .fontColor(Colors.textSecondary)
                .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                .backgroundColor(Colors.bgPrimary)
                .borderRadius(Radius.full)
                .onClick(() => {
                  const years = [1, 2, 5, 10][index];
                  const future = new Date();
                  future.setFullYear(future.getFullYear() + years);
                  this.targetDate = future.toISOString().split('T')[0];
                })
            })
          }
          .width('100%')
          .margin({ top: 12 })
          .justifyContent(FlexAlign.SpaceBetween)
        }
        .width('100%')
        .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 24 })

        // æ·»åŠ å›¾ç‰‡
        Column() {
          Text('æ·»åŠ ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰')
            .fontSize(FontSizes.bodySmall)
            .fontWeight(FontWeight.Bold)
            .fontColor(Colors.textPrimary)
            .width('100%')
            .margin({ bottom: 12 })

          Row() {
            Column() {
              Text('+')
                .fontSize(32)
                .fontColor(Colors.textTertiary)
            }
            .width(80)
            .height(80)
            .backgroundColor(Colors.bgPrimary)
            .borderRadius(Radius.md)
            .justifyContent(FlexAlign.Center)
            .border({ width: 1, color: Colors.border, style: BorderStyle.Dashed })
          }
          .width('100%')
        }
        .width('100%')
        .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 24 })

        // åŸ‹ä¸‹æŒ‰é’®
        Button('ðŸ’Š åŸ‹ä¸‹æ—¶ç©ºèƒ¶å›Š')
          .width('80%')
          .height(56)
          .fontSize(FontSizes.bodyLarge)
          .fontColor(Colors.textWhite)
          .backgroundColor(this.content ? Colors.primary : Colors.bgTertiary)
          .borderRadius(Radius.full)
          .margin({ top: 40, bottom: 40 })
          .enabled(!!this.content)
          .onClick(() => this.buryCapusle())
      }
    }
    .width('100%')
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  @Builder
  MyCapsulesContent() {
    if (this.myCapsules.length > 0) {
      List() {
        ForEach(this.myCapsules, (capsule: TimeCapsule) => {
          ListItem() {
            Column() {
              // çŠ¶æ€å’Œæ—¥æœŸ
              Row() {
                Row() {
                  Text(capsule.status === 'locked' ? 'ðŸ”’' : 'ðŸ”“')
                    .fontSize(16)
                  Text(capsule.status === 'locked' ? 'å¾…è§£å°' : 'å·²è§£å°')
                    .fontSize(FontSizes.small)
                    .fontColor(capsule.status === 'locked' ? Colors.textTertiary : Colors.success)
                    .margin({ left: 6 })
                }
                .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                .backgroundColor(capsule.status === 'locked' ? Colors.bgSecondary : '#E6F7E6')
                .borderRadius(Radius.tag)

                Blank()

                Text(this.formatDate(capsule.createdAt.split('T')[0]))
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textQuaternary)
              }
              .width('100%')
              .margin({ bottom: 12 })

              // å†…å®¹
              if (capsule.status === 'unlocked') {
                Text(capsule.content)
                  .fontSize(FontSizes.body)
                  .fontColor(Colors.textPrimary)
                  .lineHeight(22)
                  .width('100%')
              } else {
                Row() {
                  Text('ðŸ” å†…å®¹å·²åŠ å¯†')
                    .fontSize(FontSizes.body)
                    .fontColor(Colors.textTertiary)
                }
                .width('100%')
                .height(60)
                .backgroundColor(Colors.bgSecondary)
                .borderRadius(Radius.md)
                .justifyContent(FlexAlign.Center)
              }

              // è§£å°æ—¥æœŸ
              Row() {
                Text('ðŸ“')
                  .fontSize(FontSizes.small)
                Text(capsule.location.cityName)
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textTertiary)
                  .margin({ left: 4 })

                Blank()

                if (capsule.status === 'locked') {
                  Text(`${this.formatDate(capsule.targetDate)} è§£å°`)
                    .fontSize(FontSizes.small)
                    .fontColor(Colors.primary)
                } else {
                  Text('ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹')
                    .fontSize(FontSizes.small)
                    .fontColor(Colors.primary)
                }
              }
              .width('100%')
              .margin({ top: 12 })
            }
            .width('100%')
            .padding(Spacing.cardPadding)
            .backgroundColor(Colors.bgPrimary)
            .borderRadius(Radius.card)
          }
          .margin({ bottom: Spacing.cardMargin })
        })
      }
      .width('100%')
      .height('100%')
      .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 16, bottom: 16 })
      .scrollBar(BarState.Off)
    } else {
      Column() {
        Text('ðŸ’Š')
          .fontSize(60)
          .opacity(0.5)
        Text('è¿˜æ²¡æœ‰åŸ‹ä¸‹æ—¶ç©ºèƒ¶å›Š')
          .fontSize(FontSizes.body)
          .fontColor(Colors.textTertiary)
          .margin({ top: 16 })
        Button('åŸ‹ä¸€ä¸ª')
          .fontSize(FontSizes.bodySmall)
          .fontColor(Colors.primary)
          .backgroundColor(Colors.primaryLightest)
          .borderRadius(Radius.full)
          .height(36)
          .padding({ left: 24, right: 24 })
          .margin({ top: 16 })
          .onClick(() => {
            this.currentTab = 0;
          })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    }
  }
}
