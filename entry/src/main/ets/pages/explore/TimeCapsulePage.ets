/**
 * æ—¶ç©ºèƒ¶å›Šé¡µé¢ - æ˜Ÿç©ºä¸»é¢˜æ²‰æµ¸å¼è®¾è®¡
 */

import { router } from '@kit.ArkUI';
import { TimeCapsule, CapsuleLocation } from '../../models/TimeCapsule'; 

@Entry
@Component
struct TimeCapsulePage {
  @State currentTab: number = 0;
  @State content: string = '';
  @State targetDate: string = '';
  @State myCapsules: TimeCapsule[] = [];
  @State selectedYearIndex: number = 0;
  @State capsuleFloat: number = 0;

  private yearOptions: string[] = ['1å¹´åŽ', '2å¹´åŽ', '5å¹´åŽ', '10å¹´åŽ'];
  private yearValues: number[] = [1, 2, 5, 10];

  aboutToAppear(): void {
    this.loadMyCapsules();
    this.setTargetYear(0);
    this.startFloatAnimation();
  }

  private startFloatAnimation(): void {
    setInterval(() => {
      animateTo({ duration: 2500, curve: Curve.EaseInOut }, () => {
        this.capsuleFloat = this.capsuleFloat === 0 ? -8 : 0;
      });
    }, 2500);
  }

  private setTargetYear(index: number): void {
    this.selectedYearIndex = index;
    const future = new Date();
    future.setFullYear(future.getFullYear() + this.yearValues[index]);
    this.targetDate = future.toISOString().split('T')[0];
  }

  private loadMyCapsules(): void {
    this.myCapsules = [
      {
        id: 'capsule_001',
        content: 'å¸Œæœ›æ˜Žå¹´çš„è‡ªå·±å·²ç»å®žçŽ°äº†çŽ¯çƒæ—…è¡Œçš„æ¢¦æƒ³ï¼åŠ æ²¹ï¼ðŸ’ª',
        images: [],
        targetDate: '2026-12-31',
        createdAt: new Date(Date.now() - 30 * 86400000).toISOString(),
        location: { cityName: 'åŒ—äº¬', address: 'å›½è´¸' },
        status: 'locked',
      },
      {
        id: 'capsule_002',
        content: 'ä»Šå¤©æ˜¯æ¯•ä¸šæ—…è¡Œçš„æœ€åŽä¸€å¤©ï¼Œå’Œæœ€å¥½çš„æœ‹å‹ä»¬åœ¨é¼“æµªå±¿çœ‹äº†æœ€ç¾Žçš„æ—¥è½...',
        images: [],
        targetDate: '2024-06-01',
        createdAt: new Date(Date.now() - 365 * 86400000).toISOString(),
        location: { cityName: 'åŽ¦é—¨', address: 'é¼“æµªå±¿' },
        status: 'unlocked',
      },
      {
        id: 'capsule_003',
        content: 'ðŸ” å†…å®¹å·²åŠ å¯†ï¼Œç­‰å¾…è§£å°...',
        images: [],
        targetDate: '2028-01-01',
        createdAt: new Date(Date.now() - 60 * 86400000).toISOString(),
        location: { cityName: 'æˆéƒ½', address: 'å®½çª„å··å­' },
        status: 'locked',
      },
    ];
  }

  private buryCapsule(): void {
    if (!this.content.trim()) return;

    const newCapsule: TimeCapsule = {
      id: `capsule_${Date.now()}`,
      content: this.content,
      images: [],
      targetDate: this.targetDate,
      createdAt: new Date().toISOString(),
      location: { cityName: 'åŒ—äº¬', address: 'å½“å‰ä½ç½®' },
      status: 'locked',
    };
    this.myCapsules = [newCapsule, ...this.myCapsules];
    this.content = '';
    this.currentTab = 1;
  }

  private formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    return `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`;
  }

  private getDaysRemaining(targetDate: string): number {
    const target = new Date(targetDate);
    const now = new Date();
    const diff = target.getTime() - now.getTime();
    return Math.max(0, Math.ceil(diff / 86400000));
  }

  build() {
    Stack() {
      // æ˜Ÿç©ºèƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [
            ['#0F172A', 0],
            ['#1E293B', 0.3],
            ['#1E3A5F', 0.6],
            ['#1E40AF', 0.85],
            ['#3B82F6', 1]
          ]
        })

      // æ˜Ÿæ˜Ÿè£…é¥°
      Column().width(3).height(3).borderRadius(1.5)
        .backgroundColor('#FFFFFF').opacity(0.6).position({ x: '15%', y: '8%' })
      Column().width(2).height(2).borderRadius(1)
        .backgroundColor('#FFFFFF').opacity(0.4).position({ x: '82%', y: '5%' })
      Column().width(4).height(4).borderRadius(2)
        .backgroundColor('#FFFFFF').opacity(0.3).position({ x: '45%', y: '3%' })
      Column().width(2).height(2).borderRadius(1)
        .backgroundColor('#FFFFFF').opacity(0.5).position({ x: '70%', y: '12%' })
      Column().width(3).height(3).borderRadius(1.5)
        .backgroundColor('#FFFFFF').opacity(0.25).position({ x: '25%', y: '15%' })
      Column().width(2).height(2).borderRadius(1)
        .backgroundColor('#FFFFFF').opacity(0.4).position({ x: '90%', y: '18%' })

      // å…‰æ•ˆè£…é¥°
      Column()
        .width(250)
        .height(250)
        .borderRadius(125)
        .backgroundColor('#3B82F6')
        .opacity(0.08)
        .blur(80)
        .position({ x: '60%', y: '10%' })

      Column()
        .width(180)
        .height(180)
        .borderRadius(90)
        .backgroundColor('#8B5CF6')
        .opacity(0.06)
        .blur(60)
        .position({ x: '10%', y: '35%' })

      // å†…å®¹
      Column() {
        this.NavigationBar()
        this.TabBar()

        if (this.currentTab === 0) {
          this.BuryContent()
        } else {
          this.MyCapsulesContent()
        }
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }

  // ==================== å¯¼èˆªæ  ====================

  @Builder
  NavigationBar() {
    Stack() {
      Column() {
        Text('æ—¶ç©ºèƒ¶å›Š')
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        Text('å†™ç»™æœªæ¥çš„è‡ªå·±')
          .fontSize(11)
          .fontColor('rgba(255,255,255,0.5)')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Center)
      .width('100%')

      Row() {
        Column() {
          Text('â†')
            .fontSize(22)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
        }
        .width(38)
        .height(38)
        .borderRadius(19)
        .backgroundColor('rgba(255,255,255,0.1)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => { router.back(); })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 44, bottom: 8 })
  }

  // ==================== Tabæ  ====================

  @Builder
  TabBar() {
    Row() {
      Row() {
        ForEach(['åŸ‹ä¸‹èƒ¶å›Š', 'æˆ‘çš„èƒ¶å›Š'], (tab: string, index: number) => {
          Column() {
            Text(tab)
              .fontSize(14)
              .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Medium)
              .fontColor(this.currentTab === index ? '#FFFFFF' : 'rgba(255,255,255,0.4)')
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Center)
          .height('100%')
          .onClick(() => { this.currentTab = index; })
        })
      }
      .width('65%')
      .height(40)
      .backgroundColor('rgba(255,255,255,0.1)')
      .borderRadius(20)
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .margin({ top: 4, bottom: 8 })
  }

  // ==================== åŸ‹ä¸‹èƒ¶å›Š ====================

  @Builder
  BuryContent() {
    Scroll() {
      Column() {
        // èƒ¶å›Šå›¾æ ‡ + æ¼‚æµ®åŠ¨ç”»
        Column({ space: 8 }) {
          Text('â³')
            .fontSize(64)
            .translate({ y: this.capsuleFloat })

          Text('å°å­˜æ­¤åˆ»ï¼Œå¯„å¾€æœªæ¥')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('rgba(255,255,255,0.9)')
            .margin({ top: 12 })

          Text('è¿™å°ä¿¡å°†åœ¨ä½ é€‰æ‹©çš„æ—¥æœŸè§£å°')
            .fontSize(12)
            .fontColor('rgba(255,255,255,0.4)')
        }
        .width('100%')
        .alignItems(HorizontalAlign.Center)
        .padding({ top: 24, bottom: 24 })

        // å†…å®¹è¾“å…¥å¡ç‰‡
        Column() {
          Row() {
            Text('âœï¸')
              .fontSize(14)
            Text('å†™ä¸‹ä½ æƒ³è¯´çš„è¯')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1E293B')
              .margin({ left: 6 })
          }
          .width('100%')
          .margin({ bottom: 12 })

          TextArea({
            placeholder: 'å†™ç»™æœªæ¥çš„è‡ªå·±ï¼Œæˆ–è€…è®°å½•æ­¤åˆ»çš„å¿ƒæƒ…...',
            text: this.content
          })
            .width('100%')
            .height(160)
            .fontSize(14)
            .fontColor('#1E293B')
            .placeholderColor('#94A3B8')
            .backgroundColor('#F8FAFC')
            .borderRadius(12)
            .padding(14)
            .onChange((value: string) => { this.content = value; })

          Row() {
            Blank()
            Text(`${this.content.length}/500`)
              .fontSize(11)
              .fontColor('#94A3B8')
          }
          .width('100%')
          .margin({ top: 6 })
        }
        .width('100%')
        .padding(20)
        .margin({ left: 20, right: 20 })
        .backgroundColor('rgba(255,255,255,0.92)')
        .borderRadius(20)

        // è§£å°æ—¥æœŸé€‰æ‹©
        Column() {
          Row() {
            Text('ðŸ“…')
              .fontSize(14)
            Text('é€‰æ‹©è§£å°æ—¶é—´')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1E293B')
              .margin({ left: 6 })
          }
          .width('100%')
          .margin({ bottom: 16 })

          // å½“å‰é€‰æ‹©çš„æ—¥æœŸ
          Row() {
            Column() {
              Text(this.formatDate(this.targetDate))
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1E293B')
              Text(`è¿˜æœ‰ ${this.getDaysRemaining(this.targetDate)} å¤©`)
                .fontSize(12)
                .fontColor('#3B82F6')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)

            Blank()

            Text('â³')
              .fontSize(28)
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#F0F9FF')
          .borderRadius(14)
          .margin({ bottom: 14 })

          // å¿«æ·é€‰æ‹©
          Row({ space: 8 }) {
            ForEach(this.yearOptions, (label: string, index: number) => {
              Column() {
                Text(label)
                  .fontSize(13)
                  .fontWeight(this.selectedYearIndex === index ? FontWeight.Bold : FontWeight.Medium)
                  .fontColor(this.selectedYearIndex === index ? '#FFFFFF' : '#64748B')
              }
              .layoutWeight(1)
              .height(38)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .backgroundColor(this.selectedYearIndex === index ? '#3B82F6' : '#F1F5F9')
              .borderRadius(19)
              .onClick(() => { this.setTargetYear(index); })
            })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .margin({ left: 20, right: 20, top: 16 })
        .backgroundColor('rgba(255,255,255,0.92)')
        .borderRadius(20)

        // æ·»åŠ ç…§ç‰‡
        Column() {
          Row() {
            Text('ðŸ“·')
              .fontSize(14)
            Text('æ·»åŠ ç…§ç‰‡')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1E293B')
              .margin({ left: 6 })

            Text('å¯é€‰')
              .fontSize(11)
              .fontColor('#94A3B8')
              .margin({ left: 6 })
          }
          .width('100%')
          .margin({ bottom: 12 })

          Row() {
            Column() {
              Text('+')
                .fontSize(24)
                .fontColor('#94A3B8')
              Text('æ·»åŠ ')
                .fontSize(10)
                .fontColor('#CBD5E1')
                .margin({ top: 4 })
            }
            .width(72)
            .height(72)
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
            .backgroundColor('#F8FAFC')
            .borderRadius(12)
            .border({ width: 1.5, color: '#E2E8F0', style: BorderStyle.Dashed })
          }
          .width('100%')
        }
        .width('100%')
        .padding(20)
        .margin({ left: 20, right: 20, top: 16 })
        .backgroundColor('rgba(255,255,255,0.92)')
        .borderRadius(20)

        // åŸ‹ä¸‹æŒ‰é’®
        Column() {
          Row() {
            Text('â³')
              .fontSize(18)
            Text('å°å­˜è¿™ä¸€åˆ»')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.content.trim() ? '#FFFFFF' : 'rgba(255,255,255,0.4)')
              .margin({ left: 8 })
          }
          .width('80%')
          .height(52)
          .justifyContent(FlexAlign.Center)
          .linearGradient({
            direction: GradientDirection.Right,
            colors: this.content.trim()
              ? [['#3B82F6', 0], ['#8B5CF6', 1]]
              : [['rgba(255,255,255,0.1)', 0], ['rgba(255,255,255,0.1)', 1]]
          })
          .borderRadius(26)
          .shadow(this.content.trim()
            ? { radius: 16, color: 'rgba(59,130,246,0.3)', offsetY: 4 }
            : { radius: 0, color: 'transparent', offsetY: 0 })
          .onClick(() => { this.buryCapsule(); })
        }
        .margin({ top: 32, bottom: 60 })
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .layoutWeight(1)
    .scrollBar(BarState.Off)
  }

  // ==================== æˆ‘çš„èƒ¶å›Š ====================

  @Builder
  MyCapsulesContent() {
    if (this.myCapsules.length > 0) {
      Scroll() {
        Column({ space: 12 }) {
          // ç»Ÿè®¡
          Row({ space: 20 }) {
            Column() {
              Text(`${this.myCapsules.length}`)
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('æ€»è®¡')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.5)')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Center)

            Column()
              .width(1)
              .height(28)
              .backgroundColor('rgba(255,255,255,0.2)')

            Column() {
              Text(`${this.myCapsules.filter((c: TimeCapsule) => c.status === 'locked').length}`)
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('å¾…è§£å°')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.5)')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Center)

            Column()
              .width(1)
              .height(28)
              .backgroundColor('rgba(255,255,255,0.2)')

            Column() {
              Text(`${this.myCapsules.filter((c: TimeCapsule) => c.status === 'unlocked').length}`)
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('å·²è§£å°')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.5)')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
          .padding({ top: 16, bottom: 16 })
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255,255,255,0.08)')
          .borderRadius(16)

          // èƒ¶å›Šåˆ—è¡¨
          ForEach(this.myCapsules, (capsule: TimeCapsule) => {
            Column() {
              // é¡¶éƒ¨ï¼šçŠ¶æ€ + æ—¥æœŸ
              Row() {
                Row() {
                  Text(capsule.status === 'locked' ? 'ðŸ”’' : 'âœ¨')
                    .fontSize(13)
                  Text(capsule.status === 'locked' ? 'å¾…è§£å°' : 'å·²è§£å°')
                    .fontSize(12)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(capsule.status === 'locked' ? '#64748B' : '#059669')
                    .margin({ left: 4 })
                }
                .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                .backgroundColor(capsule.status === 'locked' ? '#F1F5F9' : '#ECFDF5')
                .borderRadius(10)

                Blank()

                Text(this.formatDate(capsule.createdAt.split('T')[0]))
                  .fontSize(11)
                  .fontColor('#94A3B8')
              }
              .width('100%')

              // å†…å®¹
              if (capsule.status === 'unlocked') {
                Text(capsule.content)
                  .fontSize(14)
                  .fontColor('#1E293B')
                  .lineHeight(22)
                  .margin({ top: 14 })
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              } else {
                // åŠ å¯†å†…å®¹
                Row() {
                  Column() {
                    Text('ðŸ”')
                      .fontSize(24)
                  }
                  .margin({ right: 12 })

                  Column() {
                    Text('å†…å®¹å·²åŠ å¯†å°å­˜')
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#64748B')

                    Row() {
                      Text(`${this.getDaysRemaining(capsule.targetDate)}`)
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#3B82F6')
                      Text(' å¤©åŽè§£å°')
                        .fontSize(13)
                        .fontColor('#94A3B8')
                    }
                    .margin({ top: 4 })
                  }
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .padding(14)
                .backgroundColor('#F8FAFC')
                .borderRadius(12)
                .margin({ top: 14 })
              }

              // åº•éƒ¨ï¼šä½ç½® + è§£å°æ—¥æœŸ
              Column()
                .width('100%')
                .height(1)
                .backgroundColor('#F1F5F9')
                .margin({ top: 14, bottom: 12 })

              Row() {
                Row() {
                  Text('ðŸ“')
                    .fontSize(12)
                  Text(`${capsule.location.cityName} Â· ${capsule.location.address}`)
                    .fontSize(12)
                    .fontColor('#94A3B8')
                    .margin({ left: 4 })
                }

                Blank()

                Text(`${this.formatDate(capsule.targetDate)} è§£å°`)
                  .fontSize(12)
                  .fontColor(capsule.status === 'locked' ? '#3B82F6' : '#94A3B8')
              }
              .width('100%')
            }
            .width('100%')
            .padding(18)
            .backgroundColor('rgba(255,255,255,0.92)')
            .borderRadius(18)
          })
        }
        .padding({ left: 20, right: 20, top: 12, bottom: 80 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    } else {
      Column() {
        Blank()
        Column({ space: 12 }) {
          Text('â³')
            .fontSize(60)
            .opacity(0.5)
          Text('è¿˜æ²¡æœ‰åŸ‹ä¸‹æ—¶ç©ºèƒ¶å›Š')
            .fontSize(15)
            .fontColor('rgba(255,255,255,0.7)')
          Row() {
            Text('åŸ‹ä¸‹ç¬¬ä¸€ä¸ª')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#3B82F6')
          }
          .padding({ left: 24, right: 24, top: 10, bottom: 10 })
          .backgroundColor('rgba(255,255,255,0.9)')
          .borderRadius(20)
          .onClick(() => { this.currentTab = 0; })
        }
        .alignItems(HorizontalAlign.Center)
        Blank()
      }
      .width('100%')
      .layoutWeight(1)
    }
  }
}