/**
 * æ¼‚æµç“¶é¡µé¢ - æµ·æ´‹ä¸»é¢˜æ²‰æµ¸å¼è®¾è®¡
 */

import { router } from '@kit.ArkUI';
import { DriftBottle, DriftBottleTypeOption } from '../../models/DriftBottle';

@Entry
@Component
struct DriftBottlePage {
  @State currentTab: number = 0;
  @State pickedBottle: DriftBottle | null = null;
  @State myContent: string = '';
  @State selectedType: 'wish' | 'story' | 'question' = 'wish';
  @State isPicking: boolean = false;
  @State myBottles: DriftBottle[] = [];
  @State bottleFloat: number = 0;

  private typeOptions: DriftBottleTypeOption[] = [
    { key: 'wish', label: 'è®¸æ„¿', icon: 'ğŸŒŸ', desc: 'è®¸ä¸‹å¿ƒæ„¿', color: '#FEF3C7' },
    { key: 'story', label: 'æ•…äº‹', icon: 'ğŸ“–', desc: 'åˆ†äº«æ•…äº‹', color: '#DBEAFE' },
    { key: 'question', label: 'æé—®', icon: 'â“', desc: 'æŠ›å‡ºé—®é¢˜', color: '#FCE7F3' },
  ];

  aboutToAppear(): void {
    this.loadMyBottles();
    this.startBottleAnimation();
  }

  private startBottleAnimation(): void {
    setInterval(() => {
      animateTo({ duration: 2000, curve: Curve.EaseInOut }, () => {
        this.bottleFloat = this.bottleFloat === 0 ? -12 : 0;
      });
    }, 2000);
  }

  private loadMyBottles(): void {
    this.myBottles = [
      {
        id: 'bottle_001',
        content: 'å¸Œæœ›ä»Šå¹´èƒ½å»ä¸€æ¬¡æ—¥æœ¬çœ‹æ¨±èŠ± ğŸŒ¸',
        senderNickname: 'æˆ‘',
        senderCity: 'åŒ—äº¬',
        createdAt: new Date(Date.now() - 86400000).toISOString(),
        type: 'wish',
      },
      {
        id: 'bottle_002',
        content: 'åœ¨æˆéƒ½åƒåˆ°äº†è¶…çº§å¥½åƒçš„ç«é”…ï¼Œåˆ†äº«ç»™æœ‰ç¼˜äºº ğŸŒ¶ï¸',
        senderNickname: 'æˆ‘',
        senderCity: 'æˆéƒ½',
        createdAt: new Date(Date.now() - 172800000).toISOString(),
        type: 'story',
      },
      {
        id: 'bottle_003',
        content: 'ä¸€ä¸ªäººæ—…è¡Œæ˜¯ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿæœ‰æ²¡æœ‰äººåˆ†äº«ä¸€ä¸‹ç»éªŒï¼Ÿ',
        senderNickname: 'æˆ‘',
        senderCity: 'ä¸Šæµ·',
        createdAt: new Date(Date.now() - 259200000).toISOString(),
        type: 'question',
      },
    ];
  }

  private pickBottle(): void {
    if (this.isPicking) return;
    this.isPicking = true;
    this.pickedBottle = null;

    setTimeout(() => {
      this.isPicking = false;
      this.pickedBottle = {
        id: `bottle_${Date.now()}`,
        content: 'å¸Œæœ›æ¯ä¸ªçœ‹åˆ°è¿™æ¡æ¶ˆæ¯çš„äººéƒ½èƒ½å¼€å¿ƒæ¯ä¸€å¤©ï¼é‡è§ç¾å¥½ï¼Œé‡è§å¹¸ç¦ âœ¨',
        senderNickname: 'æ¼‚æµè€…',
        senderCity: 'ä¸Šæµ·',
        createdAt: new Date(Date.now() - 3600000 * 5).toISOString(),
        type: 'wish',
      };
    }, 2000);
  }

  private throwBottle(): void {
    if (!this.myContent.trim()) return;

    const newBottle: DriftBottle = {
      id: `bottle_${Date.now()}`,
      content: this.myContent,
      senderNickname: 'æˆ‘',
      senderCity: 'åŒ—äº¬',
      createdAt: new Date().toISOString(),
      type: this.selectedType,
    };
    this.myBottles = [newBottle, ...this.myBottles];
    this.myContent = '';
  }

  private formatTime(isoString: string): string {
    const date = new Date(isoString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (hours < 1) return 'åˆšåˆš';
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days < 7) return `${days}å¤©å‰`;
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  private getTypeInfo(type: string): DriftBottleTypeOption {
    return this.typeOptions.find(t => t.key === type) ||
      { key: 'wish' as 'wish', label: 'è®¸æ„¿', icon: 'ğŸŒŸ', desc: '', color: '#FEF3C7' };
  }

  build() {
    Stack() {
      // æµ·æ´‹èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [
            ['#E0F2FE', 0],
            ['#BAE6FD', 0.3],
            ['#7DD3FC', 0.6],
            ['#38BDF8', 0.85],
            ['#0EA5E9', 1]
          ]
        })

      // å†…å®¹
      Column() {
        // å¯¼èˆªæ 
        this.NavigationBar()

        // Tab æ 
        this.TabBar()

        // å†…å®¹åŒº
        if (this.currentTab === 0) {
          this.PickContent()
        } else if (this.currentTab === 1) {
          this.ThrowContent()
        } else {
          this.MyBottlesContent()
        }
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }

  // ==================== å¯¼èˆªæ  ====================

  @Builder
  NavigationBar() {
    Stack() {
      // æ ‡é¢˜å±…ä¸­
      Column() {
        Text('æ¼‚æµç“¶')
          .fontSize(17)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1E293B')
        Text('æ¥è‡ªä¸–ç•Œå„åœ°çš„å£°éŸ³')
          .fontSize(11)
          .fontColor('#64748B')
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Center)
      .width('100%')

      // è¿”å›æŒ‰é’®é å·¦
      Row() {
        Column() {
          Text('â†')
            .fontSize(22)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1E293B')
        }
        .width(38)
        .height(38)
        .borderRadius(19)
        .backgroundColor('rgba(255,255,255,0.8)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => { router.back(); })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 44, bottom: 8 })
  }

  // ==================== Tabæ  ====================

  @Builder
  TabBar() {
    Row() {
      Row() {
        ForEach(['æ¡ç“¶', 'æŠ•ç“¶', 'æˆ‘çš„'], (tab: string, index: number) => {
          Column() {
            Text(tab)
              .fontSize(14)
              .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Medium)
              .fontColor(this.currentTab === index ? '#0369A1' : 'rgba(0,0,0,0.4)')
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Center)
          .justifyContent(FlexAlign.Center)
          .height('100%')
          .onClick(() => { this.currentTab = index; })
        })
      }
      .width('70%')
      .height(40)
      .backgroundColor('rgba(255,255,255,0.5)')
      .borderRadius(20)
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .margin({ top: 4, bottom: 8 })
  }

  // ==================== æ¡ç“¶å­ ====================

  @Builder
  PickContent() {
    Column() {
      Blank()

      if (this.isPicking) {
        // æ¡ç“¶å­åŠ¨ç”»
        Column({ space: 16 }) {
          Text('ğŸ¾')
            .fontSize(80)
            .translate({ y: this.bottleFloat })

          Text('æ­£åœ¨æµ·ä¸Šå¯»æ‰¾æ¼‚æµç“¶...')
            .fontSize(15)
            .fontColor('rgba(255,255,255,0.9)')

          LoadingProgress()
            .width(28)
            .height(28)
            .color(Color.White)
        }
        .alignItems(HorizontalAlign.Center)

      } else if (this.pickedBottle !== null) {
        // æ¡åˆ°ç“¶å­çš„ç»“æœ
        Column() {
          Text('ğŸ‰')
            .fontSize(40)
            .margin({ bottom: 8 })

          Text('ä½ æ¡åˆ°äº†ä¸€ä¸ªæ¼‚æµç“¶')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FFFFFF')

          // ç“¶å­å†…å®¹å¡ç‰‡
          Column() {
            // ç±»å‹æ ‡ç­¾
            Row() {
              Text(this.getTypeInfo(this.pickedBottle.type).icon)
                .fontSize(14)
              Text(this.getTypeInfo(this.pickedBottle.type).label)
                .fontSize(12)
                .fontColor('#64748B')
                .margin({ left: 4 })
            }
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor(this.getTypeInfo(this.pickedBottle.type).color)
            .borderRadius(12)
            .alignSelf(ItemAlign.Start)

            // å†…å®¹
            Text(this.pickedBottle.content)
              .fontSize(16)
              .fontColor('#1E293B')
              .lineHeight(26)
              .margin({ top: 16 })

            // åˆ†éš”çº¿
            Column()
              .width('100%')
              .height(1)
              .backgroundColor('#F1F5F9')
              .margin({ top: 20, bottom: 16 })

            // å‘é€è€…ä¿¡æ¯
            Row() {
              Column() {
                Text('ğŸ§‘â€âœˆï¸')
                  .fontSize(18)
              }
              .width(36)
              .height(36)
              .backgroundColor('#EFF6FF')
              .borderRadius(18)
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)

              Column() {
                Text(this.pickedBottle.senderNickname)
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#1E293B')
                Row() {
                  Text(`ğŸ“ ${this.pickedBottle.senderCity}`)
                    .fontSize(11)
                    .fontColor('#94A3B8')
                  Text(` Â· ${this.formatTime(this.pickedBottle.createdAt)}`)
                    .fontSize(11)
                    .fontColor('#94A3B8')
                }
                .margin({ top: 2 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 10 })
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .shadow({ radius: 20, color: 'rgba(0,0,0,0.08)', offsetY: 4 })
          .margin({ top: 20 })

          // æ“ä½œæŒ‰é’®
          Row({ space: 12 }) {
            Row() {
              Text('ğŸ’¬ å›å¤TA')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#0369A1')
            }
            .layoutWeight(1)
            .height(46)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('rgba(255,255,255,0.9)')
            .borderRadius(23)

            Row() {
              Text('ğŸŒŠ å†æ¡ä¸€ä¸ª')
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFFFFF')
            }
            .layoutWeight(1)
            .height(46)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('rgba(255,255,255,0.25)')
            .borderRadius(23)
            .border({ width: 1, color: 'rgba(255,255,255,0.4)' })
            .onClick(() => { this.pickBottle(); })
          }
          .width('100%')
          .margin({ top: 20 })
        }
        .width('100%')
        .padding({ left: 24, right: 24 })

      } else {
        // åˆå§‹çŠ¶æ€
        Column({ space: 12 }) {
          // æ¼‚æµç“¶æ¼‚æµ®åŠ¨ç”»
          Text('ğŸ¾')
            .fontSize(90)
            .translate({ y: this.bottleFloat })

          Text('å¤§æµ·é‡Œè—ç€å¾ˆå¤šæ•…äº‹')
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .fontColor('rgba(255,255,255,0.95)')
            .margin({ top: 16 })

          Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œæ¡ä¸€ä¸ªæ¼‚æµç“¶')
            .fontSize(13)
            .fontColor('rgba(255,255,255,0.6)')
        }
        .alignItems(HorizontalAlign.Center)
      }

      Blank()

      // æ¡ç“¶å­æŒ‰é’®
      if (this.pickedBottle === null) {
        Column() {
          Row() {
            Text('ğŸ¾')
              .fontSize(18)
            Text('æ¡ä¸€ä¸ªæ¼‚æµç“¶')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#0369A1')
              .margin({ left: 8 })
          }
          .width('80%')
          .height(52)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255,255,255,0.9)')
          .borderRadius(26)
          .shadow({ radius: 16, color: 'rgba(0,0,0,0.1)', offsetY: 4 })
          .onClick(() => { this.pickBottle(); })
        }
        .margin({ bottom: 60 })
      }
    }
    .width('100%')
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
  }

  // ==================== æŠ•ç“¶å­ ====================

  @Builder
  ThrowContent() {
    Column() {
      Scroll() {
        Column() {
          // ç±»å‹é€‰æ‹©
          Column() {
            Text('é€‰æ‹©æ¼‚æµç“¶ç±»å‹')
              .fontSize(13)
              .fontColor('rgba(255,255,255,0.7)')
              .margin({ bottom: 12 })

            Row({ space: 12 }) {
              ForEach(this.typeOptions, (option: DriftBottleTypeOption) => {
                Column() {
                  Text(option.icon)
                    .fontSize(28)
                  Text(option.label)
                    .fontSize(13)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.selectedType === option.key ? '#0369A1' : '#64748B')
                    .margin({ top: 6 })
                  Text(option.desc)
                    .fontSize(10)
                    .fontColor('#94A3B8')
                    .margin({ top: 2 })
                }
                .layoutWeight(1)
                .padding({ top: 16, bottom: 16 })
                .backgroundColor(this.selectedType === option.key ? 'rgba(255,255,255,0.95)' : 'rgba(255,255,255,0.6)')
                .borderRadius(16)
                .border({
                  width: 2,
                  color: this.selectedType === option.key ? '#38BDF8' : 'transparent'
                })
                .alignItems(HorizontalAlign.Center)
                .shadow(this.selectedType === option.key ?
                  { radius: 12, color: 'rgba(56,189,248,0.2)', offsetY: 4 } :
                  { radius: 0, color: 'transparent', offsetY: 0 })
                .onClick(() => { this.selectedType = option.key; })
              })
            }
            .width('100%')
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 20 })
          .alignItems(HorizontalAlign.Center)

          // å†…å®¹è¾“å…¥
          Column() {
            TextArea({
              placeholder: 'å†™ä¸‹ä½ æƒ³è¯´çš„è¯ï¼Œè®©å®ƒæ¼‚å‘è¿œæ–¹...',
              text: this.myContent
            })
              .width('100%')
              .height(180)
              .fontSize(15)
              .fontColor('#1E293B')
              .placeholderColor('#94A3B8')
              .backgroundColor('transparent')
              .padding(0)
              .onChange((value: string) => { this.myContent = value; })

            Row() {
              Blank()
              Text(`${this.myContent.length}/200`)
                .fontSize(12)
                .fontColor('#94A3B8')
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .margin({ left: 20, right: 20, top: 16 })
          .backgroundColor('rgba(255,255,255,0.85)')
          .borderRadius(20)
        }
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // æŠ•ç“¶æŒ‰é’®
      Column() {
        Row() {
          Text('ğŸ¾')
            .fontSize(18)
          Text('æ‰”è¿›å¤§æµ·')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.myContent.trim() ? '#FFFFFF' : 'rgba(255,255,255,0.5)')
            .margin({ left: 8 })
        }
        .width('80%')
        .height(52)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.myContent.trim() ? '#0369A1' : 'rgba(0,0,0,0.1)')
        .borderRadius(26)
        .shadow(this.myContent.trim() ?
          { radius: 16, color: 'rgba(3,105,161,0.3)', offsetY: 4 } :
          { radius: 0, color: 'transparent', offsetY: 0 })
        .onClick(() => { this.throwBottle(); })
      }
      .margin({ bottom: 60 })
    }
    .width('100%')
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
  }

  // ==================== æˆ‘çš„ç“¶å­ ====================

  @Builder
  MyBottlesContent() {
    if (this.myBottles.length > 0) {
      Scroll() {
        Column({ space: 12 }) {
          // ç»Ÿè®¡ä¿¡æ¯
          Row({ space: 16 }) {
            Column() {
              Text(`${this.myBottles.length}`)
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('å·²æŠ•å‡º')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.7)')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Center)

            Column()
              .width(1)
              .height(30)
              .backgroundColor('rgba(255,255,255,0.3)')

            Column() {
              Text('12')
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('è¢«æ¡èµ·')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.7)')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Center)

            Column()
              .width(1)
              .height(30)
              .backgroundColor('rgba(255,255,255,0.3)')

            Column() {
              Text('5')
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
              Text('æ”¶åˆ°å›å¤')
                .fontSize(11)
                .fontColor('rgba(255,255,255,0.7)')
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
          .padding({ top: 16, bottom: 16 })
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(255,255,255,0.15)')
          .borderRadius(16)

          // ç“¶å­åˆ—è¡¨
          ForEach(this.myBottles, (bottle: DriftBottle) => {
            Column() {
              Row() {
                // ç±»å‹æ ‡ç­¾
                Row() {
                  Text(this.getTypeInfo(bottle.type).icon)
                    .fontSize(12)
                  Text(this.getTypeInfo(bottle.type).label)
                    .fontSize(11)
                    .fontColor('#64748B')
                    .margin({ left: 4 })
                }
                .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                .backgroundColor(this.getTypeInfo(bottle.type).color)
                .borderRadius(10)

                Blank()

                Text(this.formatTime(bottle.createdAt))
                  .fontSize(11)
                  .fontColor('#94A3B8')
              }
              .width('100%')

              Text(bottle.content)
                .fontSize(14)
                .fontColor('#1E293B')
                .lineHeight(22)
                .margin({ top: 12 })

              Row() {
                Text(`ğŸ“ ${bottle.senderCity}`)
                  .fontSize(11)
                  .fontColor('#94A3B8')

                Blank()

                Row() {
                  Text('ğŸ’¬ 0')
                    .fontSize(11)
                    .fontColor('#94A3B8')
                }
              }
              .width('100%')
              .margin({ top: 12 })
            }
            .width('100%')
            .padding(16)
            .backgroundColor('rgba(255,255,255,0.9)')
            .borderRadius(16)
          })
        }
        .padding({ left: 20, right: 20, top: 12, bottom: 80 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    } else {
      Column() {
        Blank()
        Column({ space: 12 }) {
          Text('ğŸ¾')
            .fontSize(60)
            .opacity(0.6)
          Text('è¿˜æ²¡æœ‰æŠ•è¿‡æ¼‚æµç“¶')
            .fontSize(15)
            .fontColor('rgba(255,255,255,0.8)')
          Row() {
            Text('å»æŠ•ä¸€ä¸ª')
              .fontSize(14)
              .fontWeight(FontWeight.Medium)
              .fontColor('#0369A1')
          }
          .padding({ left: 24, right: 24, top: 10, bottom: 10 })
          .backgroundColor('rgba(255,255,255,0.9)')
          .borderRadius(20)
          .onClick(() => { this.currentTab = 1; })
        }
        .alignItems(HorizontalAlign.Center)
        Blank()
      }
      .width('100%')
      .layoutWeight(1)
    }
  }
}