/**
 * æ¼‚æµç“¶é¡µé¢- æ„¿æœ›äº’åŠ¨
 */

import { Colors, FontSizes, Spacing, Radius } from '../../utils/Constants';
import { router } from '@kit.ArkUI';

interface DriftBottle {
  id: string;
  content: string;
  senderNickname: string;
  senderCity: string;
  createdAt: string;
  type: 'wish' | 'story' | 'question';
}

interface DriftBottleTypeOption {
  key: 'wish' | 'story' | 'question';
  label: string;
  icon: string;
}

@Entry
@Component
struct DriftBottlePage {
  @State currentTab: number = 0;  // 0: æ¡ç“¶å­, 1: æŠ•ç“¶å­, 2: æˆ‘çš„ç“¶å­
  @State pickedBottle: DriftBottle | null = null;
  @State myContent: string = '';
  @State selectedType: 'wish' | 'story' | 'question' = 'wish';
  @State isPicking: boolean = false;
  @State myBottles: DriftBottle[] = [];

  private tabs: string[] = ['æ¡ç“¶', 'æŠ•ç“¶', 'æˆ‘çš„ç“¶å­'];
  private typeOptions: DriftBottleTypeOption[] = [
    { key: 'wish', label: 'è®¸æ„¿', icon: 'ğŸŒŸ' },
    { key: 'story', label: 'æ•…äº‹', icon: 'ğŸ“–' },
    { key: 'question', label: 'æé—®', icon: 'â“' },
  ];

  aboutToAppear(): void {
    this.loadMyBottles();
  }

  // åŠ è½½æˆ‘çš„æ¼‚æµç“¶
  private loadMyBottles(): void {
    this.myBottles = [
      {
        id: 'bottle_001',
        content: 'å¸Œæœ›ä»Šå¹´èƒ½å»ä¸€æ¬¡æ—¥æœ¬çœ‹æ¨±èŠ± ğŸŒ¸',
        senderNickname: 'å°å®‰',
        senderCity: 'åŒ—äº¬',
        createdAt: new Date(Date.now() - 86400000).toISOString(),
        type: 'wish',
      },
      {
        id: 'bottle_002',
        content: 'åœ¨æˆéƒ½åƒåˆ°äº†è¶…çº§å¥½åƒçš„ç«é”…ï¼Œåˆ†äº«ç»™æœ‰ç¼˜äºº',
        senderNickname: 'å°é¹¿',
        senderCity: 'æˆéƒ½',
        createdAt: new Date(Date.now() - 172800000).toISOString(),
        type: 'story',
      },
    ];
  }

  // æ¡ç“¶
  private pickBottle(): void {
    if (this.isPicking) return;

    this.isPicking = true;
    this.pickedBottle = null;

    // æ¨¡æ‹Ÿæ¡ç“¶å­è¿‡ç¨‹
    setTimeout(() => {
      this.isPicking = false;
      this.pickedBottle = {
        id: `bottle_${Date.now()}`,
        content: 'å¸Œæœ›æ¯ä¸ªçœ‹åˆ°è¿™æ¡æ¶ˆæ¯çš„äººéƒ½èƒ½å¼€å¿ƒæ¯ä¸€å¤©ï¼é‡è§ç¾å¥½ï¼Œé‡è§å¹¸ç¦ã€‚',
        senderNickname: 'æ¼‚æµè€…',
        senderCity: 'ä¸Šæµ·',
        createdAt: new Date(Date.now() - 3600000 * 5).toISOString(),
        type: 'wish',
      };
    }, 2000);
  }

  // æŠ•ç“¶
  private throwBottle(): void {
    if (!this.myContent.trim()) return;

    const newBottle: DriftBottle = {
      id: `bottle_${Date.now()}`,
      content: this.myContent,
      senderNickname: 'æ—…è¡Œè€…',
      senderCity: 'åŒ—äº¬',
      createdAt: new Date().toISOString(),
      type: this.selectedType,
    };
    this.myBottles = [newBottle, ...this.myBottles];
    this.myContent = '';

    // TODO: æ˜¾ç¤ºæˆåŠŸæç¤º
  }

  // è¿”å›
  private goBack(): void {
    router.back();
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(isoString: string): string {
    const date = new Date(isoString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);

    if (hours < 1) return 'åˆšåˆš';
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days < 7) return `${days}å¤©å‰`;
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      this.NavigationBar()

      // Tabæ 
      this.TabBar()

      // å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.PickContent()
      } else if (this.currentTab === 1) {
        this.ThrowContent()
      } else {
        this.MyBottlesContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.bgSecondary)
  }

  @Builder
  NavigationBar() {
    Row() {
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor(Colors.textPrimary)
      }
      .width(44)
      .height(44)
      .justifyContent(FlexAlign.Center)
      .onClick(() => this.goBack())

      Blank()

      Text('æ¼‚æµç“¶')
        .fontSize(FontSizes.body)
        .fontWeight(FontWeight.Bold)
        .fontColor(Colors.textPrimary)

      Blank()

      Row().width(44).height(44)
    }
    .width('100%')
    .height(56)
    .padding({ left: 4, right: 4, top: 48 })
    .backgroundColor(Colors.bgPrimary)
  }

  @Builder
  TabBar() {
    Row() {
      ForEach(this.tabs, (tab: string, index: number) => {
        Column() {
          Text(tab)
            .fontSize(FontSizes.body)
            .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)
            .fontColor(this.currentTab === index ? Colors.primary : Colors.textTertiary)
            .onClick(() => {
              this.currentTab = index;
            })

          if (this.currentTab === index) {
            Row()
              .width(24)
              .height(3)
              .backgroundColor(Colors.primary)
              .borderRadius(2)
              .margin({ top: 8 })
          } else {
            Row().height(11)
          }
        }
      })
    }
    .width('100%')
    .height(56)
    .justifyContent(FlexAlign.SpaceEvenly)
    .backgroundColor(Colors.bgPrimary)
  }

  @Builder
  PickContent() {
    Column() {
      Blank()

      // æµ·æµªåŠ¨ç”»åŒºåŸŸ
      Column() {
        if (this.isPicking) {
          // æ¡ç“¶å­åŠ¨ç”»
          Column() {
            Text('ğŸ¾')
              .fontSize(80)
            Text('æ­£åœ¨æµ·ä¸Šå¯»æ‰¾æ¼‚æµç“¶...')
              .fontSize(FontSizes.body)
              .fontColor(Colors.textSecondary)
              .margin({ top: 20 })
            LoadingProgress()
              .width(32)
              .height(32)
              .margin({ top: 16 })
          }
        } else if (this.pickedBottle) {
          // å±•ç¤ºæ¡åˆ°çš„ç“¶å­
          Column() {
            Text('ğŸ‰')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('ä½ æ¡åˆ°äº†ä¸€ä¸ªæ¼‚æµç“¶')
              .fontSize(FontSizes.h4)
              .fontWeight(FontWeight.Bold)
              .fontColor(Colors.textPrimary)

            Column() {
              Text(this.pickedBottle.content)
                .fontSize(FontSizes.body)
                .fontColor(Colors.textPrimary)
                .lineHeight(24)
                .textAlign(TextAlign.Center)

              Row() {
                Text(`æ¥è‡ª ${this.pickedBottle.senderCity}`)
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textTertiary)
                Text(' Â· ')
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textQuaternary)
                Text(this.formatTime(this.pickedBottle.createdAt))
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textTertiary)
              }
              .margin({ top: 16 })
            }
            .width('100%')
            .padding(24)
            .margin({ top: 24 })
            .backgroundColor(Colors.bgPrimary)
            .borderRadius(Radius.card)

            Row() {
              Button('å›å¤TA')
                .fontSize(FontSizes.body)
                .fontColor(Colors.primary)
                .backgroundColor(Colors.primaryLightest)
                .borderRadius(Radius.full)
                .height(44)
                .layoutWeight(1)

              Button('å†æ¡ä¸€ä¸ª')
                .fontSize(FontSizes.body)
                .fontColor(Colors.textWhite)
                .backgroundColor(Colors.primary)
                .borderRadius(Radius.full)
                .height(44)
                .layoutWeight(1)
                .margin({ left: 16 })
                .onClick(() => this.pickBottle())
            }
            .width('100%')
            .margin({ top: 24 })
          }
          .width('100%')
          .padding({ left: 24, right: 24 })
        } else {
          // ç­‰å¾…æ¡ç“¶å­çŠ¶æ€
          Column() {
            Text('ğŸŒŠ')
              .fontSize(80)
            Text('å¤§æµ·é‡Œæœ‰å¾ˆå¤šæ¼‚æµç“¶')
              .fontSize(FontSizes.body)
              .fontColor(Colors.textSecondary)
              .margin({ top: 20 })
            Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¯•è¯•è¿æ°”')
              .fontSize(FontSizes.small)
              .fontColor(Colors.textTertiary)
              .margin({ top: 8 })
          }
        }
      }

      Blank()

      // æ¡ç“¶å­æŒ‰é’®
      if (!this.pickedBottle) {
        Button('ğŸ¾ æ¡ä¸€ä¸ªæ¼‚æµç“¶')
          .width('80%')
          .height(56)
          .fontSize(FontSizes.bodyLarge)
          .fontColor(Colors.textWhite)
          .backgroundColor(Colors.primary)
          .borderRadius(Radius.full)
          .shadow({ radius: 16, color: 'rgba(14, 165, 233, 0.4)', offsetY: 4 })
          .margin({ bottom: 60 })
          .onClick(() => this.pickBottle())
          .enabled(!this.isPicking)
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  ThrowContent() {
    Column() {
      // ç±»å‹é€‰æ‹©
      Row() {
        ForEach(this.typeOptions, (option: DriftBottleTypeOption) => {
          Column() {
            Text(option.icon)
              .fontSize(28)
            Text(option.label)
              .fontSize(FontSizes.small)
              .fontColor(this.selectedType === option.key ? Colors.primary : Colors.textTertiary)
              .margin({ top: 6 })
          }
          .width(80)
          .height(80)
          .backgroundColor(this.selectedType === option.key ? Colors.primaryLightest : Colors.bgPrimary)
          .borderRadius(Radius.card)
          .border({ width: 2, color: this.selectedType === option.key ? Colors.primary : 'transparent' })
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            this.selectedType = option.key;
          })
        })
      }
      .width('100%')
      .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 24 })
      .justifyContent(FlexAlign.SpaceEvenly)

      // å†…å®¹è¾“å…¥
      Column() {
        TextArea({ placeholder: 'å†™ä¸‹ä½ æƒ³è¯´çš„è¯ï¼Œè®©å®ƒæ¼‚å‘è¿œæ–¹...', text: this.myContent })
          .width('100%')
          .height(200)
          .fontSize(FontSizes.body)
          .backgroundColor(Colors.bgPrimary)
          .borderRadius(Radius.card)
          .padding(16)
          .onChange((value: string) => {
            this.myContent = value;
          })

        Text(`${this.myContent.length}/200`)
          .fontSize(FontSizes.small)
          .fontColor(Colors.textTertiary)
          .margin({ top: 8 })
          .alignSelf(ItemAlign.End)
      }
      .width('100%')
      .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 24 })

      Blank()

      // æŠ•ç“¶å­æŒ‰é’®
      Button('ğŸ¾ æ‰”è¿›å¤§æµ·')
        .width('80%')
        .height(56)
        .fontSize(FontSizes.bodyLarge)
        .fontColor(Colors.textWhite)
        .backgroundColor(this.myContent ? Colors.primary : Colors.bgTertiary)
        .borderRadius(Radius.full)
        .margin({ bottom: 60 })
        .enabled(!!this.myContent)
        .onClick(() => this.throwBottle())
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  MyBottlesContent() {
    if (this.myBottles.length > 0) {
      List() {
        ForEach(this.myBottles, (bottle: DriftBottle) => {
          ListItem() {
            Column() {
              Row() {
                Text(this.typeOptions.find(t => t.key === bottle.type)?.icon || 'ğŸ¾')
                  .fontSize(20)
                Text(this.typeOptions.find(t => t.key === bottle.type)?.label || '')
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textTertiary)
                  .margin({ left: 8 })
                Blank()
                Text(this.formatTime(bottle.createdAt))
                  .fontSize(FontSizes.small)
                  .fontColor(Colors.textQuaternary)
              }
              .width('100%')
              .margin({ bottom: 12 })

              Text(bottle.content)
                .fontSize(FontSizes.body)
                .fontColor(Colors.textPrimary)
                .lineHeight(22)
                .width('100%')

              Row() {
                Text(`å‘è‡ª ${bottle.senderCity}`)
                  .fontSize(FontSizes.mini)
                  .fontColor(Colors.textTertiary)
              }
              .width('100%')
              .margin({ top: 12 })
            }
            .width('100%')
            .padding(Spacing.cardPadding)
            .backgroundColor(Colors.bgPrimary)
            .borderRadius(Radius.card)
          }
          .margin({ bottom: Spacing.cardMargin })
        })
      }
      .width('100%')
      .height('100%')
      .padding({ left: Spacing.pagePadding, right: Spacing.pagePadding, top: 16, bottom: 16 })
      .scrollBar(BarState.Off)
    } else {
      Column() {
        Text('ğŸ¾')
          .fontSize(60)
          .opacity(0.5)
        Text('è¿˜æ²¡æœ‰æŠ•è¿‡æ¼‚æµç“¶')
          .fontSize(FontSizes.body)
          .fontColor(Colors.textTertiary)
          .margin({ top: 16 })
        Button('å»æŠ•ä¸€ä¸ª')
          .fontSize(FontSizes.bodySmall)
          .fontColor(Colors.primary)
          .backgroundColor(Colors.primaryLightest)
          .borderRadius(Radius.full)
          .height(36)
          .padding({ left: 24, right: 24 })
          .margin({ top: 16 })
          .onClick(() => {
            this.currentTab = 1;
          })
      }
      .width('100%')
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
    }
  }
}
